{{ 'component-stories.css' | asset_url | stylesheet_tag }}

{%- liquid
  assign sectionId = section.id | remove: '-'
  assign enable_animations = section.settings.enable_animations
  assign animation = section.settings.animation

  assign bgImage = section.settings.image_bg_colored
  assign bgImageMobile = section.settings.image_bg_colored_mobile
  if section.settings.enable_cut_bg_color or bgImage != blank or bgImageMobile != blank
    render 'cut-colored'
  endif
-%}

<style>
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top_sm }}px;
    padding-bottom: {{ section.settings.padding_bottom_sm }}px;
  }
  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
  {%- if section.settings.accent__gradient -%}
    #stories__{{ sectionId }} .popup-video__opener {
      background: rgb(var(--color-accent-1)) !important;
    }
  {%- endif -%}

  /* ===================================
     STORIES ULTRA - SCROLL HORIZONTAL
     =================================== */
  #stories__{{ sectionId }} {
    display: flex;
    flex-direction: row;
    flex-wrap: nowrap;
    overflow-x: auto;
    overflow-y: hidden;
    gap: {{ section.settings.stories_gap_mobile }}px;
    padding: 1.5rem 0;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: rgba(var(--color-foreground), 0.2) transparent;
  }
  
  @media screen and (min-width: 750px) {
    #stories__{{ sectionId }} {
      gap: {{ section.settings.stories_gap }}px;
      padding: 2rem 0;
    }
  }
  
  #stories__{{ sectionId }}::-webkit-scrollbar {
    height: 6px;
  }
  
  #stories__{{ sectionId }}::-webkit-scrollbar-track {
    background: rgba(var(--color-foreground), 0.05);
    border-radius: 3px;
  }
  
  #stories__{{ sectionId }}::-webkit-scrollbar-thumb {
    background: rgba(var(--color-foreground), 0.2);
    border-radius: 3px;
  }
  
  #stories__{{ sectionId }}::-webkit-scrollbar-thumb:hover {
    background: rgba(var(--color-foreground), 0.3);
  }
  
  /* TAILLE DES STORIES */
  #stories__{{ sectionId }} .stories__slide {
    flex: 0 0 auto;
    width: {{ section.settings.story_size_mobile }}px;
  }
  
  @media screen and (min-width: 750px) {
    #stories__{{ sectionId }} .stories__slide {
      width: {{ section.settings.story_size }}px;
    }
  }
  
  .stories__alignement--center #stories__{{ sectionId }} {
    justify-content: center;
  }
  .stories__alignement--right #stories__{{ sectionId }} {
    justify-content: flex-end;
  }

  /* ===================================
     BOUTON STORY - ANIMATIONS ULTRA
     =================================== */
  #stories__{{ sectionId }} .stories__button {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.6rem;
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    width: 100%;
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
  }

  #stories__{{ sectionId }} .stories__button:hover {
    transform: translateY(-8px);
  }

  /* ===================================
     CERCLE STORY - BORDURE ANIM√âE
     =================================== */
  #stories__{{ sectionId }} .popup-video__opener {
    position: relative;
    width: {{ section.settings.story_size_mobile }}px;
    height: {{ section.settings.story_size_mobile }}px;
    border-radius: 50%;
    padding: 3px;
    background: radial-gradient(circle at 30% 107%, #fdf497 0%, #fdf497 5%, #fd5949 45%, #d6249f 60%, #285aeb 90%);
    overflow: visible;
    transition: all 0.3s ease;
  }
  
  @media screen and (min-width: 750px) {
    #stories__{{ sectionId }} .popup-video__opener {
      width: {{ section.settings.story_size }}px;
      height: {{ section.settings.story_size }}px;
      padding: 4px;
    }
  }

  #stories__{{ sectionId }} .stories__button:hover .popup-video__opener {
    filter: brightness(1.1);
    box-shadow: 0 8px 20px rgba(253, 89, 73, 0.3);
  }

  /* CERCLE DE PROGRESSION ANIM√â */
  #stories__{{ sectionId }} .progress-ring {
    position: absolute;
    top: -2px;
    left: -2px;
    width: calc(100% + 4px);
    height: calc(100% + 4px);
    z-index: 1;
    pointer-events: none;
  }

  #stories__{{ sectionId }} .progress-ring circle {
    stroke: url(#gradient__{{ sectionId }});
    stroke-width: 3;
    fill: none;
    stroke-linecap: round;
    transform-origin: center;
    transform: rotate(-90deg);
    animation: progressPulse__{{ sectionId }} 3s ease-in-out infinite;
  }

  @keyframes progressPulse__{{ sectionId }} {
    0%, 100% {
      stroke-dashoffset: 350;
      opacity: 0.7;
    }
    50% {
      stroke-dashoffset: 0;
      opacity: 1;
    }
  }

  /* STORY D√âJ√Ä VUE - Bordure grise */
  #stories__{{ sectionId }} .stories__button.story--viewed .popup-video__opener {
    background: linear-gradient(135deg, #d0d0d0 0%, #a0a0a0 50%, #d0d0d0 100%) !important;
  }

  #stories__{{ sectionId }} .stories__button.story--viewed .progress-ring {
    display: none;
  }

  /* ===================================
     INT√âRIEUR DU CERCLE
     =================================== */
  #stories__{{ sectionId }} .stories__inner-circle {
    position: relative;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    overflow: hidden;
    background: rgb(var(--color-background));
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  /* VIDEO PREVIEW AUTOPLAY */
  #stories__{{ sectionId }} .stories__preview-video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
    z-index: 2;
    transition: transform 0.3s ease;
  }

  #stories__{{ sectionId }} .stories__button:hover .stories__preview-video {
    transform: scale(1.05);
  }

  /* IMAGE THUMBNAIL */
  #stories__{{ sectionId }} .stories__thumbnail-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
    z-index: 1;
    transition: transform 0.3s ease;
  }

  #stories__{{ sectionId }} .stories__button:hover .stories__thumbnail-image {
    transform: scale(1.05);
  }

  /* PLACEHOLDER */
  #stories__{{ sectionId }} .stories__thumbnail-placeholder {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%);
    border-radius: 50%;
    z-index: 1;
  }

  /* ===================================
     ICONE PLAY - EFFET PULSE
     =================================== */
  #stories__{{ sectionId }} .stories__play-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 32px;
    height: 32px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    z-index: 3;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  
  #stories__{{ sectionId }} .stories__play-icon svg {
    width: 14px;
    height: 14px;
    color: #fd5949;
    margin-left: 2px;
  }
  
  #stories__{{ sectionId }} .stories__button:hover .stories__play-icon {
    opacity: 1;
    animation: pulse__{{ sectionId }} 1.5s ease-in-out infinite;
  }

  @keyframes pulse__{{ sectionId }} {
    0%, 100% {
      transform: translate(-50%, -50%) scale(1);
    }
    50% {
      transform: translate(-50%, -50%) scale(1.15);
    }
  }

  /* ===================================
     BADGE "NEW" - ANIMATION BOUNCE
     =================================== */
  #stories__{{ sectionId }} .story__badge-new {
    position: absolute;
    top: -5px;
    right: -5px;
    background: linear-gradient(135deg, #FD7049, #F91418);
    color: white;
    font-size: 9px;
    font-weight: 700;
    padding: 3px 7px;
    border-radius: 12px;
    z-index: 10;
    animation: bounceIn__{{ sectionId }} 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    box-shadow: 0 2px 8px rgba(249, 20, 24, 0.4);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  @media screen and (min-width: 750px) {
    #stories__{{ sectionId }} .story__badge-new {
      font-size: 10px;
      padding: 4px 8px;
    }
  }

  @keyframes bounceIn__{{ sectionId }} {
    0% {
      transform: scale(0) rotate(-45deg);
      opacity: 0;
    }
    50% {
      transform: scale(1.2) rotate(10deg);
    }
    100% {
      transform: scale(1) rotate(0deg);
      opacity: 1;
    }
  }

  /* ===================================
     COMPTEUR DE VUES
     =================================== */
  #stories__{{ sectionId }} .story__view-count {
    position: absolute;
    bottom: -2px;
    right: -2px;
    background: rgba(0, 0, 0, 0.75);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    color: white;
    font-size: 9px;
    font-weight: 600;
    padding: 3px 6px;
    border-radius: 10px;
    z-index: 10;
    display: flex;
    align-items: center;
    gap: 3px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }

  @media screen and (min-width: 750px) {
    #stories__{{ sectionId }} .story__view-count {
      font-size: 10px;
      padding: 4px 7px;
    }
  }

  #stories__{{ sectionId }} .story__view-count::before {
    content: 'üëÅÔ∏è';
    font-size: 11px;
  }

  /* ===================================
     NOM DE LA STORY
     =================================== */
  #stories__{{ sectionId }} .story__name {
    font-size: 1.1rem;
    font-weight: 500;
    color: rgb(var(--color-foreground));
    text-align: center;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    margin: 0;
    transition: color 0.2s ease;
  }
  
  @media screen and (min-width: 750px) {
    #stories__{{ sectionId }} .story__name {
      font-size: 1.2rem;
    }
  }

  #stories__{{ sectionId }} .stories__button:hover .story__name {
    color: #fd5949;
  }

  /* ===================================
     EFFET SHIMMER LOADING
     =================================== */
  #stories__{{ sectionId }} .stories__loading {
    background: linear-gradient(90deg, 
      rgba(var(--color-foreground), 0.05) 25%, 
      rgba(var(--color-foreground), 0.1) 50%, 
      rgba(var(--color-foreground), 0.05) 75%
    );
    background-size: 200% 100%;
    animation: shimmer__{{ sectionId }} 1.5s infinite;
  }

  @keyframes shimmer__{{ sectionId }} {
    0% {
      background-position: -200% 0;
    }
    100% {
      background-position: 200% 0;
    }
  }

  /* ===================================
     CONVERSION BOOSTERS - AJOUTS
     =================================== */

  /* BADGE MEILLEUR CHOIX */
  #stories__{{ sectionId }} .story__badge-best {
    position: absolute;
    top: -12px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #1a1a1a;
    font-size: 8px;
    font-weight: 800;
    padding: 4px 10px;
    border-radius: 20px;
    z-index: 15;
    white-space: nowrap;
    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.5);
    animation: bestBadgePulse__{{ sectionId }} 2s ease-in-out infinite;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  @media screen and (min-width: 750px) {
    #stories__{{ sectionId }} .story__badge-best {
      font-size: 9px;
      padding: 5px 12px;
      top: -14px;
    }
  }

  @keyframes bestBadgePulse__{{ sectionId }} {
    0%, 100% {
      transform: translateX(-50%) scale(1);
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.5);
    }
    50% {
      transform: translateX(-50%) scale(1.05);
      box-shadow: 0 6px 25px rgba(255, 215, 0, 0.7);
    }
  }

  /* BADGE V√âRIFI√â */
  #stories__{{ sectionId }} .story__verified-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
    background: linear-gradient(135deg, #1DA1F2, #0d8bd9);
    border-radius: 50%;
    margin-left: 4px;
    vertical-align: middle;
    box-shadow: 0 2px 6px rgba(29, 161, 242, 0.4);
  }

  #stories__{{ sectionId }} .story__verified-badge svg {
    width: 10px;
    height: 10px;
    color: white;
  }

  /* INDICATEUR DE SUCC√àS / CHECK CIRCLE */
  #stories__{{ sectionId }} .story__success-indicator {
    position: absolute;
    bottom: 8px;
    left: 8px;
    width: 22px;
    height: 22px;
    background: linear-gradient(135deg, #10B981, #059669);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 12;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.5);
    animation: successPop__{{ sectionId }} 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  #stories__{{ sectionId }} .story__success-indicator svg {
    width: 12px;
    height: 12px;
    color: white;
  }

  @keyframes successPop__{{ sectionId }} {
    0% { transform: scale(0); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
  }

  /* COMPTEUR DE SATISFACTION ANIM√â */
  #stories__{{ sectionId }} .story__satisfaction {
    position: absolute;
    top: 8px;
    left: 8px;
    background: rgba(16, 185, 129, 0.95);
    backdrop-filter: blur(8px);
    color: white;
    font-size: 10px;
    font-weight: 700;
    padding: 4px 8px;
    border-radius: 12px;
    z-index: 12;
    display: flex;
    align-items: center;
    gap: 3px;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
  }

  #stories__{{ sectionId }} .story__satisfaction-value {
    font-weight: 800;
  }

  /* URGENCE / RARET√â BADGE */
  #stories__{{ sectionId }} .story__urgency-badge {
    position: absolute;
    bottom: -8px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #EF4444, #DC2626);
    color: white;
    font-size: 8px;
    font-weight: 700;
    padding: 3px 8px;
    border-radius: 10px;
    z-index: 14;
    white-space: nowrap;
    box-shadow: 0 2px 10px rgba(239, 68, 68, 0.5);
    animation: urgencyPulse__{{ sectionId }} 1s ease-in-out infinite;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  @keyframes urgencyPulse__{{ sectionId }} {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  /* SOCIAL PROOF COUNTER */
  #stories__{{ sectionId }} .story__social-proof {
    position: absolute;
    top: -8px;
    right: -8px;
    background: linear-gradient(135deg, #8B5CF6, #7C3AED);
    color: white;
    font-size: 9px;
    font-weight: 700;
    padding: 4px 8px;
    border-radius: 12px;
    z-index: 13;
    display: flex;
    align-items: center;
    gap: 3px;
    box-shadow: 0 2px 10px rgba(139, 92, 246, 0.5);
  }

  #stories__{{ sectionId }} .story__social-proof::before {
    content: 'üî•';
    font-size: 10px;
  }

  /* LIVE INDICATOR */
  #stories__{{ sectionId }} .story__live-indicator {
    position: absolute;
    top: 8px;
    right: 8px;
    background: #EF4444;
    color: white;
    font-size: 8px;
    font-weight: 800;
    padding: 3px 8px;
    border-radius: 4px;
    z-index: 14;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    gap: 4px;
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.5);
  }

  #stories__{{ sectionId }} .story__live-indicator::before {
    content: '';
    width: 6px;
    height: 6px;
    background: white;
    border-radius: 50%;
    animation: liveBlink__{{ sectionId }} 1s ease-in-out infinite;
  }

  @keyframes liveBlink__{{ sectionId }} {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  /* GLOW EFFECT SUR STORY FEATURED */
  #stories__{{ sectionId }} .stories__slide.story--featured .popup-video__opener {
    box-shadow: 0 0 30px rgba(253, 89, 73, 0.5),
                0 0 60px rgba(253, 89, 73, 0.3),
                0 0 90px rgba(253, 89, 73, 0.1);
    animation: featuredGlow__{{ sectionId }} 2s ease-in-out infinite;
  }

  @keyframes featuredGlow__{{ sectionId }} {
    0%, 100% {
      box-shadow: 0 0 30px rgba(253, 89, 73, 0.5),
                  0 0 60px rgba(253, 89, 73, 0.3),
                  0 0 90px rgba(253, 89, 73, 0.1);
    }
    50% {
      box-shadow: 0 0 40px rgba(253, 89, 73, 0.6),
                  0 0 80px rgba(253, 89, 73, 0.4),
                  0 0 120px rgba(253, 89, 73, 0.2);
    }
  }

  /* TOOLTIP AU SURVOL */
  #stories__{{ sectionId }} .story__tooltip {
    position: absolute;
    bottom: calc(100% + 15px);
    left: 50%;
    transform: translateX(-50%) translateY(10px);
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(10px);
    color: white;
    font-size: 11px;
    padding: 8px 14px;
    border-radius: 8px;
    white-space: nowrap;
    z-index: 20;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    pointer-events: none;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  }

  #stories__{{ sectionId }} .story__tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 6px solid transparent;
    border-top-color: rgba(0, 0, 0, 0.9);
  }

  #stories__{{ sectionId }} .stories__button:hover .story__tooltip {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
  }

  /* RATING STARS */
  #stories__{{ sectionId }} .story__rating {
    display: flex;
    align-items: center;
    gap: 2px;
    margin-top: 4px;
  }

  #stories__{{ sectionId }} .story__rating-star {
    width: 12px;
    height: 12px;
    color: #FFD700;
  }

  #stories__{{ sectionId }} .story__rating-count {
    font-size: 10px;
    color: rgba(var(--color-foreground), 0.7);
    margin-left: 4px;
  }

  /* CTA FLOTTANT */
  #stories__{{ sectionId }} .story__cta-float {
    position: absolute;
    bottom: -35px;
    left: 50%;
    transform: translateX(-50%) scale(0.9);
    background: linear-gradient(135deg, #10B981, #059669);
    color: white;
    font-size: 10px;
    font-weight: 700;
    padding: 6px 14px;
    border-radius: 20px;
    white-space: nowrap;
    z-index: 16;
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    cursor: pointer;
    border: none;
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
  }

  #stories__{{ sectionId }} .stories__button:hover .story__cta-float {
    opacity: 1;
    transform: translateX(-50%) scale(1);
  }

  #stories__{{ sectionId }} .story__cta-float:hover {
    background: linear-gradient(135deg, #059669, #047857);
    transform: translateX(-50%) scale(1.05);
  }

  /* CONVERSION COUNTER WIDGET */
  .stories__conversion-widget--{{ sectionId }} {
    display: flex;
    justify-content: center;
    gap: 30px;
    margin-top: 25px;
    padding: 20px;
    background: rgba(var(--color-foreground), 0.03);
    border-radius: 16px;
  }

  .stories__conversion-stat {
    text-align: center;
  }

  .stories__conversion-value {
    font-size: 2.5rem;
    font-weight: 800;
    background: linear-gradient(135deg, #10B981, #059669);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1;
  }

  .stories__conversion-label {
    font-size: 0.85rem;
    color: rgba(var(--color-foreground), 0.7);
    margin-top: 5px;
  }

  /* TESTIMONIAL WIDGET */
  .stories__testimonial-widget--{{ sectionId }} {
    margin-top: 30px;
    padding: 25px;
    background: linear-gradient(135deg, rgba(var(--color-foreground), 0.02), rgba(var(--color-foreground), 0.05));
    border-radius: 20px;
    text-align: center;
    position: relative;
    overflow: hidden;
  }

  .stories__testimonial-widget--{{ sectionId }}::before {
    content: '"';
    position: absolute;
    top: -20px;
    left: 20px;
    font-size: 120px;
    color: rgba(var(--color-foreground), 0.05);
    font-family: Georgia, serif;
    line-height: 1;
  }

  .stories__testimonial-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    margin: 0 auto 15px;
    border: 3px solid #10B981;
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
  }

  .stories__testimonial-text {
    font-size: 1.1rem;
    line-height: 1.6;
    color: rgb(var(--color-foreground));
    font-style: italic;
    max-width: 500px;
    margin: 0 auto 15px;
  }

  .stories__testimonial-author {
    font-weight: 700;
    color: rgb(var(--color-foreground));
  }

  .stories__testimonial-role {
    font-size: 0.85rem;
    color: rgba(var(--color-foreground), 0.6);
  }

  /* CTA GLOBAL SYNCHRONIZED */
  .stories__global-cta--{{ sectionId }} {
    display: flex;
    justify-content: center;
    margin-top: 30px;
  }

  .stories__global-cta-button {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    background: linear-gradient(135deg, #10B981, #059669);
    color: white;
    font-size: 1.1rem;
    font-weight: 700;
    padding: 16px 35px;
    border-radius: 50px;
    border: none;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 0 8px 30px rgba(16, 185, 129, 0.4);
    text-decoration: none;
    position: relative;
    overflow: hidden;
  }

  .stories__global-cta-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s ease;
  }

  .stories__global-cta-button:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 40px rgba(16, 185, 129, 0.5);
  }

  .stories__global-cta-button:hover::before {
    left: 100%;
  }

  .stories__global-cta-icon {
    width: 20px;
    height: 20px;
    animation: ctaIconBounce__{{ sectionId }} 1s ease-in-out infinite;
  }

  @keyframes ctaIconBounce__{{ sectionId }} {
    0%, 100% { transform: translateX(0); }
    50% { transform: translateX(5px); }
  }

  /* TRUST BADGES ROW */
  .stories__trust-badges--{{ sectionId }} {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 20px;
    margin-top: 25px;
    padding: 15px;
  }

  .stories__trust-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
    color: rgba(var(--color-foreground), 0.7);
  }

  .stories__trust-badge-icon {
    width: 20px;
    height: 20px;
    color: #10B981;
  }

  /* MICRO-INTERACTIONS */
  #stories__{{ sectionId }} .stories__slide {
    transition: transform 0.3s ease;
  }

  #stories__{{ sectionId }} .stories__slide:hover {
    z-index: 5;
  }

  /* ENTR√âE PROGRESSIVE */
  #stories__{{ sectionId }} .stories__slide[data-animate-in="true"] {
    opacity: 0;
    transform: translateY(30px) scale(0.9);
  }

  #stories__{{ sectionId }} .stories__slide.animate-in {
    animation: slideIn__{{ sectionId }} 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  }

  @keyframes slideIn__{{ sectionId }} {
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
</style>

{%- render 'separator-top', section: section -%}

<div id="{{ section.settings.section_id }}"
  class="color-{{ section.settings.color_palette }} section-{{ section.id }}-padding{% if section.settings.enable_cut_bg_color or bgImage != blank or bgImageMobile != blank %} cut-colored-section{% endif %} stories__alignement--{{ section.settings.alignment }}"
  data-section-id="{{ section.id }}"
  data-conversion-tracking="stories-ultra"
>
  <div class="container container--{{ section.settings.layout_width }}">
    <div class="stories">
      {%- if section.settings.heading != blank -%}
        {%- render 'heading',
          alignment: section.settings.alignment,
          enable_animations: section.settings.enable_animations,
          animation: section.settings.animation,
          subheading: section.settings.subheading,
          heading: section.settings.heading,
          description: section.settings.description,
          heading_class: 'video__heading',
          heading_style: section.settings.heading_style
        -%}
      {%- endif -%}

      <div id="stories__{{ sectionId }}" class="stories__grid">
        {%- assign story_index = 0 -%}
        {%- for block in section.blocks -%}
          <div
            class="stories__slide{% if block.settings.is_featured %} story--featured{% endif %}"
            data-animate-in="{% if section.settings.enable_animations %}true{% else %}false{% endif %}"
            data-story-index="{{ story_index }}"
            data-conversion-element="story-card"
            {%- render 'animation', enable_animations: enable_animations, animation: animation -%}
            {{ block.shopify_attributes }}
          >
            <button 
              type="button" 
              class="stories__button"
              data-story-index="{{ story_index }}"
              data-section-id="{{ sectionId }}"
              data-conversion-action="story-click"
            >
              {%- comment -%} BADGE MEILLEUR CHOIX {%- endcomment -%}
              {%- if block.settings.show_best_badge -%}
                <div class="story__badge-best">‚≠ê {{ block.settings.best_badge_text }}</div>
              {%- endif -%}

              {%- comment -%} Badge NEW si activ√© {%- endcomment -%}
              {%- if block.settings.show_new_badge -%}
                <div class="story__badge-new">NEW</div>
              {%- endif -%}

              {%- comment -%} TOOLTIP AU SURVOL {%- endcomment -%}
              {%- if block.settings.tooltip_text != blank -%}
                <div class="story__tooltip">{{ block.settings.tooltip_text }}</div>
              {%- endif -%}

              <div class="popup-video__opener">
                {%- comment -%} Cercle de progression anim√© {%- endcomment -%}
                <svg class="progress-ring" viewBox="0 0 100 100">
                  <defs>
                    <linearGradient id="gradient__{{ sectionId }}" x1="0%" y1="0%" x2="100%" y2="100%">
                      <stop offset="0%" style="stop-color:#FD7049;stop-opacity:1" />
                      <stop offset="100%" style="stop-color:#F91418;stop-opacity:1" />
                    </linearGradient>
                  </defs>
                  <circle cx="50" cy="50" r="48" stroke-dasharray="350" stroke-dashoffset="350"/>
                </svg>

                {%- comment -%} INDICATEUR LIVE {%- endcomment -%}
                {%- if block.settings.show_live_indicator -%}
                  <div class="story__live-indicator">Live</div>
                {%- endif -%}

                {%- comment -%} SATISFACTION COUNTER {%- endcomment -%}
                {%- if block.settings.satisfaction_percent > 0 -%}
                  <div class="story__satisfaction" data-counter-target="{{ block.settings.satisfaction_percent }}">
                    <span class="story__satisfaction-value" data-animate-counter>{{ block.settings.satisfaction_percent }}%</span>
                    <span>satisfaits</span>
                  </div>
                {%- endif -%}

                {%- comment -%} SUCCESS INDICATOR (CHECK CIRCLE) {%- endcomment -%}
                {%- if block.settings.show_success_indicator -%}
                  <div class="story__success-indicator">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                  </div>
                {%- endif -%}

                <div class="stories__inner-circle">
                  {%- comment -%} Video preview autoplay {%- endcomment -%}
                  {%- if block.settings.video != blank -%}
                    <video 
                      class="stories__preview-video"
                      src="{{ block.settings.video.sources[1].url | default: block.settings.video.sources[0].url }}"
                      muted
                      loop
                      playsinline
                      autoplay
                      preload="auto"
                      poster="{% if block.settings.video.preview_image %}{{ block.settings.video.preview_image | image_url: width: 200 }}{% endif %}"
                    ></video>
                  {%- endif -%}
                  
                  {%- comment -%} Image thumbnail {%- endcomment -%}
                  {%- if block.settings.image != blank -%}
                    <img 
                      src="{{ block.settings.image | image_url: width: 150 }}"
                      srcset="{{ block.settings.image | image_url: width: 100 }} 100w,
                              {{ block.settings.image | image_url: width: 150 }} 150w,
                              {{ block.settings.image | image_url: width: 200 }} 200w"
                      sizes="(max-width: 749px) {{ section.settings.story_size_mobile }}px, {{ section.settings.story_size }}px"
                      alt="{{ block.settings.name | escape }}"
                      loading="lazy"
                      class="stories__thumbnail-image stories__loading"
                    >
                  {%- elsif block.settings.video != blank and block.settings.video.preview_image -%}
                    <img 
                      src="{{ block.settings.video.preview_image | image_url: width: 150 }}"
                      srcset="{{ block.settings.video.preview_image | image_url: width: 100 }} 100w,
                              {{ block.settings.video.preview_image | image_url: width: 150 }} 150w,
                              {{ block.settings.video.preview_image | image_url: width: 200 }} 200w"
                      sizes="(max-width: 749px) {{ section.settings.story_size_mobile }}px, {{ section.settings.story_size }}px"
                      alt="{{ block.settings.name | escape }}"
                      loading="lazy"
                      class="stories__thumbnail-image stories__loading"
                    >
                  {%- elsif block.settings.video_url != blank and block.settings.video_url.type == 'youtube' -%}
                    <img 
                      src="https://img.youtube.com/vi/{{ block.settings.video_url.id }}/hqdefault.jpg"
                      alt="{{ block.settings.name | escape }}"
                      loading="lazy"
                      class="stories__thumbnail-image stories__loading"
                    >
                  {%- else -%}
                    <div class="stories__thumbnail-placeholder stories__loading"></div>
                  {%- endif -%}
                  
                  <div class="stories__play-icon">
                    {%- render 'icon-play' -%}
                  </div>
                </div>

                {%- comment -%} SOCIAL PROOF COUNTER {%- endcomment -%}
                {%- if block.settings.social_proof_count > 0 -%}
                  <div class="story__social-proof" data-conversion-element="social-proof">
                    {{ block.settings.social_proof_count }}+ vues
                  </div>
                {%- endif -%}

                {%- comment -%} Compteur de vues {%- endcomment -%}
                {%- if block.settings.view_count and block.settings.view_count > 0 -%}
                  <div class="story__view-count">
                    {%- if block.settings.view_count >= 1000 -%}
                      {{ block.settings.view_count | divided_by: 1000.0 | round: 1 }}k
                    {%- else -%}
                      {{ block.settings.view_count }}
                    {%- endif -%}
                  </div>
                {%- endif -%}

                {%- comment -%} URGENCE BADGE {%- endcomment -%}
                {%- if block.settings.urgency_text != blank -%}
                  <div class="story__urgency-badge">{{ block.settings.urgency_text }}</div>
                {%- endif -%}
              </div>

              {%- comment -%} NOM + VERIFIED BADGE {%- endcomment -%}
              <p class="story__name">
                {{ block.settings.name }}
                {%- if block.settings.is_verified -%}
                  <span class="story__verified-badge">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                  </span>
                {%- endif -%}
              </p>

              {%- comment -%} RATING STARS {%- endcomment -%}
              {%- if block.settings.rating > 0 -%}
                <div class="story__rating">
                  {%- for i in (1..5) -%}
                    <svg class="story__rating-star" viewBox="0 0 24 24" fill="{% if i <= block.settings.rating %}currentColor{% else %}none{% endif %}" stroke="currentColor" stroke-width="2">
                      <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                    </svg>
                  {%- endfor -%}
                  {%- if block.settings.rating_count > 0 -%}
                    <span class="story__rating-count">({{ block.settings.rating_count }})</span>
                  {%- endif -%}
                </div>
              {%- endif -%}

              {%- comment -%} CTA FLOTTANT {%- endcomment -%}
              {%- if block.settings.cta_text != blank -%}
                <span class="story__cta-float" data-conversion-action="story-cta">{{ block.settings.cta_text }}</span>
              {%- endif -%}
            </button>
          </div>
          {%- assign story_index = story_index | plus: 1 -%}
        {%- endfor -%}
      </div>

      {%- comment -%} COMPTEURS DE CONVERSION {%- endcomment -%}
      {%- if section.settings.show_conversion_stats -%}
        <div class="stories__conversion-widget--{{ sectionId }}" data-conversion-element="stats-widget">
          <div class="stories__conversion-stat">
            <div class="stories__conversion-value" data-counter="{{ section.settings.stat_1_value }}">0%</div>
            <div class="stories__conversion-label">{{ section.settings.stat_1_label }}</div>
          </div>
          <div class="stories__conversion-stat">
            <div class="stories__conversion-value" data-counter="{{ section.settings.stat_2_value }}">0%</div>
            <div class="stories__conversion-label">{{ section.settings.stat_2_label }}</div>
          </div>
          {%- if section.settings.stat_3_value > 0 -%}
            <div class="stories__conversion-stat">
              <div class="stories__conversion-value" data-counter="{{ section.settings.stat_3_value }}">0%</div>
              <div class="stories__conversion-label">{{ section.settings.stat_3_label }}</div>
            </div>
          {%- endif -%}
        </div>
      {%- endif -%}

      {%- comment -%} T√âMOIGNAGE CLIENT {%- endcomment -%}
      {%- if section.settings.show_testimonial -%}
        <div class="stories__testimonial-widget--{{ sectionId }}" data-conversion-element="testimonial">
          {%- if section.settings.testimonial_avatar != blank -%}
            <img src="{{ section.settings.testimonial_avatar | image_url: width: 120 }}" alt="Client" class="stories__testimonial-avatar" loading="lazy">
          {%- endif -%}
          <p class="stories__testimonial-text">"{{ section.settings.testimonial_text }}"</p>
          <p class="stories__testimonial-author">{{ section.settings.testimonial_author }}</p>
          <p class="stories__testimonial-role">{{ section.settings.testimonial_role }}</p>
        </div>
      {%- endif -%}

      {%- comment -%} TRUST BADGES {%- endcomment -%}
      {%- if section.settings.show_trust_badges -%}
        <div class="stories__trust-badges--{{ sectionId }}" data-conversion-element="trust-badges">
          <div class="stories__trust-badge">
            <svg class="stories__trust-badge-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
              <polyline points="9 12 12 15 16 10"></polyline>
            </svg>
            <span>Paiement securise</span>
          </div>
          <div class="stories__trust-badge">
            <svg class="stories__trust-badge-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="1" y="3" width="15" height="13"></rect>
              <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
              <circle cx="5.5" cy="18.5" r="2.5"></circle>
              <circle cx="18.5" cy="18.5" r="2.5"></circle>
            </svg>
            <span>Livraison rapide</span>
          </div>
          <div class="stories__trust-badge">
            <svg class="stories__trust-badge-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
              <line x1="4" y1="22" x2="4" y2="15"></line>
            </svg>
            <span>Garantie 30 jours</span>
          </div>
        </div>
      {%- endif -%}

      {%- comment -%} CTA GLOBAL SYNCHRONIS√â {%- endcomment -%}
      {%- if section.settings.show_global_cta -%}
        <div class="stories__global-cta--{{ sectionId }}">
          <button 
            type="button" 
            class="stories__global-cta-button"
            data-conversion-action="global-cta"
            data-pack-section="{{ section.settings.pack_section_id }}"
            data-add-to-cart="{{ section.settings.cta_product_id }}"
          >
            {{ section.settings.global_cta_text }}
            <svg class="stories__global-cta-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="5" y1="12" x2="19" y2="12"></line>
              <polyline points="12 5 19 12 12 19"></polyline>
            </svg>
          </button>
        </div>
      {%- endif -%}

    </div>
  </div>
</div>

{%- render 'separator-bottom', section: section -%}

{%- comment -%} DONN√âES JSON POUR LE JAVASCRIPT {%- endcomment -%}
<script type="application/json" id="storiesData__{{ sectionId }}">
{
  "sectionId": "{{ sectionId }}",
  "videoType": "{{ section.settings.type__video }}",
  "loop": {{ section.settings.enable_video_looping | default: false }},
  "autoplay": {{ section.settings.enable_autoplay | default: true }},
  "enableReactions": {{ section.settings.enable_reactions | default: true }},
  "enableProgress": {{ section.settings.enable_progress_bar | default: true }},
  "enableAnimations": {{ section.settings.enable_animations | default: true }},
  "packSectionId": "{{ section.settings.pack_section_id }}",
  "ctaProductId": "{{ section.settings.cta_product_id }}",
  "stories": [
    {%- assign first_story = true -%}
    {%- for block in section.blocks -%}
      {%- unless first_story -%},{%- endunless -%}
      {
        "name": {{ block.settings.name | json }},
        "hasShopifyVideo": {% if block.settings.video != blank %}true{% else %}false{% endif %},
        "shopifyVideoUrl": "{% if block.settings.video != blank %}{{ block.settings.video.sources[1].url | default: block.settings.video.sources[0].url }}{% endif %}",
        "shopifyVideoPoster": "{% if block.settings.video != blank and block.settings.video.preview_image %}{{ block.settings.video.preview_image | image_url: width: 800 }}{% endif %}",
        "externalType": "{% if block.settings.video_url != blank %}{{ block.settings.video_url.type }}{% endif %}",
        "externalId": "{% if block.settings.video_url != blank %}{{ block.settings.video_url.id }}{% endif %}",
        "isFeatured": {{ block.settings.is_featured | default: false }},
        "isVerified": {{ block.settings.is_verified | default: false }}
      }
      {%- assign first_story = false -%}
    {%- endfor -%}
  ]
}
</script>
{%- comment -%} CSS DU MODAL {%- endcomment -%}
<style>
  .story__popup-overlay {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    z-index: 999999 !important;
    background: rgba(0, 0, 0, 0.85) !important;
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), 
                visibility 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .story__popup-overlay.story__popup--visible {
    opacity: 1 !important;
    visibility: visible !important;
  }

  .story__popup-content {
    position: relative !important;
    width: 85% !important;
    max-width: 380px !important;
    max-height: 80vh !important;
    z-index: 1000000 !important;
    transform: scale(0.9);
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .story__popup--visible .story__popup-content {
    transform: scale(1);
  }

  @media screen and (min-width: 750px) {
    .story__popup-content {
      width: 90% !important;
      max-width: 420px !important;
      max-height: 85vh !important;
    }
  }

  .story__popup-video-container {
    position: relative !important;
    width: 100% !important;
    background: #000 !important;
    border-radius: 20px !important;
    overflow: hidden !important;
    box-shadow: 0 40px 80px -20px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.1);
    transition: box-shadow 0.3s ease;
  }

  .story__popup-video-container:hover {
    box-shadow: 0 50px 100px -20px rgba(0, 0, 0, 0.6),
                0 0 0 1px rgba(255, 255, 255, 0.15);
  }

  .story__popup-video-container video,
  .story__popup-video-container iframe {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    border: none !important;
    border-radius: 20px !important;
  }

  .story__popup-video-container video {
    object-fit: cover;
  }

  .story__popup-progress-bar {
    position: absolute !important;
    top: 12px !important;
    left: 12px !important;
    right: 12px !important;
    height: 3px !important;
    background: rgba(255, 255, 255, 0.3) !important;
    border-radius: 2px !important;
    overflow: hidden !important;
    z-index: 1000001 !important;
  }

  .story__popup-progress-fill {
    height: 100% !important;
    background: linear-gradient(90deg, #fff, rgba(255,255,255,0.8)) !important;
    width: 0% !important;
    transition: width 0.1s linear !important;
    box-shadow: 0 0 10px rgba(255,255,255,0.5);
  }

  .story__popup-close {
    position: absolute !important;
    top: -50px !important;
    right: 0 !important;
    width: 42px !important;
    height: 42px !important;
    border: none !important;
    background: rgba(255, 255, 255, 0.15) !important;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 50% !important;
    cursor: pointer !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
    z-index: 1000001 !important;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .story__popup-close:hover {
    background: rgba(255, 255, 255, 0.25) !important;
    transform: rotate(90deg) scale(1.1) !important;
    border-color: rgba(255, 255, 255, 0.3);
  }

  .story__popup-close svg {
    width: 22px;
    height: 22px;
    color: white;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
  }

  @media screen and (min-width: 750px) {
    .story__popup-close {
      top: 0 !important;
      right: -55px !important;
      width: 46px !important;
      height: 46px !important;
    }
    .story__popup-close svg {
      width: 24px;
      height: 24px;
    }
  }

  .story__popup-prev,
  .story__popup-next {
    position: absolute !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    width: 46px !important;
    height: 46px !important;
    border: none !important;
    background: rgba(255, 255, 255, 0.15) !important;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 50% !important;
    cursor: pointer !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
    color: white !important;
    z-index: 1000001 !important;
    border: 1px solid rgba(255, 255, 255, 0.2);
    opacity: 0;
    pointer-events: none;
  }

  .story__popup--visible .story__popup-prev,
  .story__popup--visible .story__popup-next {
    opacity: 1;
    pointer-events: auto;
  }

  .story__popup-prev:hover,
  .story__popup-next:hover {
    background: rgba(255, 255, 255, 0.25) !important;
    transform: translateY(-50%) scale(1.1) !important;
    border-color: rgba(255, 255, 255, 0.3);
  }

  .story__popup-prev { left: 10px !important; }
  .story__popup-next { right: 10px !important; }

  @media screen and (min-width: 750px) {
    .story__popup-prev { left: 20px !important; }
    .story__popup-next { right: 20px !important; }
    .story__popup-prev,
    .story__popup-next {
      width: 52px !important;
      height: 52px !important;
    }
  }

  .story__popup-prev svg,
  .story__popup-next svg {
    width: 22px;
    height: 22px;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
  }

  @media screen and (min-width: 750px) {
    .story__popup-prev svg,
    .story__popup-next svg {
      width: 26px;
      height: 26px;
    }
  }

  .story__popup-title {
    position: absolute !important;
    bottom: -50px !important;
    left: 0 !important;
    right: 0 !important;
    text-align: center !important;
    color: white !important;
    font-size: 1.4rem !important;
    font-weight: 600 !important;
    text-shadow: 0 2px 8px rgba(0,0,0,0.4);
    opacity: 0;
    transform: translateY(-10px);
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  .story__popup--visible .story__popup-title {
    opacity: 1;
    transform: translateY(0);
    transition-delay: 0.2s;
  }

  @media screen and (min-width: 750px) {
    .story__popup-title {
      font-size: 1.6rem !important;
      bottom: -60px !important;
    }
  }

  .story__popup-reactions {
    position: absolute !important;
    bottom: 20px !important;
    left: 50% !important;
    transform: translateX(-50%);
    display: flex !important;
    gap: 12px !important;
    z-index: 1000001 !important;
    opacity: 0;
    transform: translateX(-50%) translateY(20px);
    transition: opacity 0.4s ease, transform 0.4s ease;
  }

  .story__popup--visible .story__popup-reactions {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
    transition-delay: 0.3s;
  }

  .story__popup-reaction {
    width: 46px !important;
    height: 46px !important;
    border-radius: 50% !important;
    background: rgba(255, 255, 255, 0.15) !important;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-size: 22px !important;
    cursor: pointer !important;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
    user-select: none;
  }

  .story__popup-reaction:hover {
    background: rgba(255, 255, 255, 0.25) !important;
    transform: scale(1.15);
    border-color: rgba(255, 255, 255, 0.3);
  }

  .story__popup-reaction:active,
  .story__popup-reaction.active {
    animation: reactionBounce 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  @keyframes reactionBounce {
    0% { transform: scale(1); }
    30% { transform: scale(1.4); }
    60% { transform: scale(1.1); }
    100% { transform: scale(1); }
  }

  @media screen and (min-width: 750px) {
    .story__popup-reactions { gap: 15px !important; }
    .story__popup-reaction {
      width: 50px !important;
      height: 50px !important;
      font-size: 24px !important;
    }
  }

  .story__reaction-count {
    position: absolute;
    top: -8px;
    right: -8px;
    background: linear-gradient(135deg, #fd5949, #d6249f);
    color: white;
    font-size: 11px;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 10px;
    min-width: 20px;
    text-align: center;
    box-shadow: 0 2px 6px rgba(253, 89, 73, 0.4);
    animation: countPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  @keyframes countPop {
    0% { transform: scale(0); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
  }

  .story__popup-loading {
    position: absolute !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%);
    width: 50px;
    height: 50px;
    border: 4px solid rgba(255, 255, 255, 0.2);
    border-top-color: white;
    border-radius: 50%;
    animation: storyLoading 0.8s linear infinite;
    z-index: 1000002;
  }

  @keyframes storyLoading {
    to { transform: translate(-50%, -50%) rotate(360deg); }
  }

  .story__popup-pause-indicator {
    position: absolute !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) scale(0);
    width: 60px;
    height: 60px;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000002;
    transition: transform 0.2s ease;
  }

  .story__popup-pause-indicator.visible {
    transform: translate(-50%, -50%) scale(1);
  }

  .story__popup-pause-indicator svg {
    width: 30px;
    height: 30px;
    color: white;
  }


  @media screen and (max-width: 749px) {
    .story__popup-content { width: 90% !important; }
    .story__popup-video-container { border-radius: 16px !important; }
    .story__popup-reactions {
      gap: 10px !important;
      bottom: 15px !important;
    }
    .story__popup-reaction {
      width: 42px !important;
      height: 42px !important;
      font-size: 20px !important;
    }
    .story__popup-cta {
      bottom: 60px !important;
      font-size: 13px !important;
      padding: 10px 20px !important;
    }
  }

  .story__popup-overlay:focus-visible,
  .story__popup-close:focus-visible,
  .story__popup-prev:focus-visible,
  .story__popup-next:focus-visible,
  .story__popup-reaction:focus-visible {
    outline: 2px solid rgba(255, 255, 255, 0.5);
    outline-offset: 4px;
  }
</style>

{%- comment -%} JAVASCRIPT {%- endcomment -%}
<script>
(function() {
  'use strict';

  var sectionId = '{{ sectionId }}';
  var dataEl = document.getElementById('storiesData__' + sectionId);
  if (!dataEl) return;
  
  var data = JSON.parse(dataEl.textContent);
  
  var state = {
    popup: null,
    videoContainer: null,
    progressBar: null,
    progressInterval: null,
    currentIndex: 0,
    isOpen: false,
    isPaused: false,
    isNavigating: false, /* FIX 1 : Flag anti double-navigation */
    savedScrollPosition: 0, /* FIX 2 : Sauvegarde position scroll */
    viewedStoriesKey: 'viewed_stories_' + sectionId,
    reactions: {},
    conversionEvents: []
  };

  function trackConversionEvent(eventName, eventData) {
    var event = {
      event: eventName,
      timestamp: new Date().toISOString(),
      sectionId: sectionId,
      data: eventData
    };
    state.conversionEvents.push(event);
    window.dispatchEvent(new CustomEvent('stories_conversion', { detail: event }));
    if (window.dataLayer) {
      window.dataLayer.push({
        event: 'stories_' + eventName,
        stories_section_id: sectionId,
        stories_data: eventData
      });
    }
  }

  function animateCounter(element, targetValue, duration) {
    duration = duration || 2000;
    var startValue = 0;
    var startTime = null;
    
    function animate(currentTime) {
      if (!startTime) startTime = currentTime;
      var progress = Math.min((currentTime - startTime) / duration, 1);
      var easeProgress = 1 - Math.pow(1 - progress, 3);
      var currentValue = Math.floor(easeProgress * targetValue);
      element.textContent = currentValue + '%';
      if (progress < 1) requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);
  }

  function initCounters() {
    var counters = document.querySelectorAll('[data-counter]');
    if ('IntersectionObserver' in window) {
      var counterObserver = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
          if (entry.isIntersecting) {
            var target = parseInt(entry.target.getAttribute('data-counter'), 10);
            animateCounter(entry.target, target);
            counterObserver.unobserve(entry.target);
            trackConversionEvent('counter_viewed', { value: target });
          }
        });
      }, { threshold: 0.5 });
      counters.forEach(function(counter) { counterObserver.observe(counter); });
    } else {
      counters.forEach(function(counter) {
        var target = parseInt(counter.getAttribute('data-counter'), 10);
        animateCounter(counter, target);
      });
    }
  }

  function initProgressiveAnimations() {
    if (!data.enableAnimations) return;
    var slides = document.querySelectorAll('#stories__' + sectionId + ' .stories__slide[data-animate-in="true"]');
    if ('IntersectionObserver' in window) {
      var animationObserver = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry, index) {
          if (entry.isIntersecting) {
            setTimeout(function() { entry.target.classList.add('animate-in'); }, index * 100);
            animationObserver.unobserve(entry.target);
          }
        });
      }, { threshold: 0.1, rootMargin: '50px' });
      slides.forEach(function(slide) { animationObserver.observe(slide); });
    } else {
      slides.forEach(function(slide) { slide.classList.add('animate-in'); });
    }
  }

  function initGlobalCTA() {
    var ctaButton = document.querySelector('.stories__global-cta-button[data-pack-section]');
    if (!ctaButton) return;
    
    ctaButton.addEventListener('click', function(e) {
      e.preventDefault();
      var packSectionId = this.getAttribute('data-pack-section');
      var productId = this.getAttribute('data-add-to-cart');
      trackConversionEvent('global_cta_click', { packSection: packSectionId, productId: productId });
      
      var packSection = document.getElementById(packSectionId);
      if (packSection) {
        packSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        packSection.classList.add('highlight-section');
        setTimeout(function() { packSection.classList.remove('highlight-section'); }, 2000);
        return;
      }
      if (productId) { addToCart(productId); return; }
      openCartDrawer();
    });
  }

  function addToCart(variantId) {
    fetch('/cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ items: [{ id: variantId, quantity: 1 }] })
    })
    .then(function(response) { return response.json(); })
    .then(function() {
      trackConversionEvent('add_to_cart', { variantId: variantId });
      openCartDrawer();
    })
    .catch(function(error) { console.error('Add to cart error:', error); });
  }

  function openCartDrawer() {
    document.dispatchEvent(new CustomEvent('cart:open'));
    var cartDrawer = document.querySelector('cart-drawer, .cart-drawer, [data-cart-drawer], #cart-drawer');
    if (cartDrawer) {
      if (cartDrawer.open) { cartDrawer.open(); }
      else {
        cartDrawer.classList.add('is-open', 'active', 'drawer--is-open');
        cartDrawer.setAttribute('aria-hidden', 'false');
      }
    }
    var cartIcon = document.querySelector('[data-cart-trigger], .cart-icon-bubble, .header__icon--cart');
    if (cartIcon) cartIcon.click();
    trackConversionEvent('cart_drawer_opened', {});
  }

  function initStoryCTAs() {
    var storyCTAs = document.querySelectorAll('.story__cta-float');
    storyCTAs.forEach(function(cta) {
      cta.addEventListener('click', function(e) {
        e.stopPropagation();
        var storyIndex = this.closest('.stories__button').getAttribute('data-story-index');
        var storyName = data.stories[storyIndex] ? data.stories[storyIndex].name : 'unknown';
        trackConversionEvent('story_cta_click', { storyIndex: storyIndex, storyName: storyName });
        if (data.packSectionId) {
          var packSection = document.getElementById(data.packSectionId);
          if (packSection) { packSection.scrollIntoView({ behavior: 'smooth', block: 'center' }); return; }
        }
        openCartDrawer();
      });
    });
  }

  function getViewedStories() {
    try { return JSON.parse(localStorage.getItem(state.viewedStoriesKey)) || []; }
    catch (e) { return []; }
  }

  function markStoryAsViewed(index) {
    var viewed = getViewedStories();
    if (viewed.indexOf(index) === -1) {
      viewed.push(index);
      localStorage.setItem(state.viewedStoriesKey, JSON.stringify(viewed));
      trackConversionEvent('story_viewed', { storyIndex: index, storyName: data.stories[index] ? data.stories[index].name : 'unknown' });
    }
    var btn = document.querySelector('.stories__button[data-story-index="' + index + '"][data-section-id="' + sectionId + '"]');
    if (btn) btn.classList.add('story--viewed');
  }

  function applyViewedState() {
    var viewed = getViewedStories();
    viewed.forEach(function(index) {
      var btn = document.querySelector('.stories__button[data-story-index="' + index + '"][data-section-id="' + sectionId + '"]');
      if (btn) btn.classList.add('story--viewed');
    });
  }

  function forceAutoplayPreviews() {
    var videos = document.querySelectorAll('#stories__' + sectionId + ' .stories__preview-video');
    videos.forEach(function(video) {
      video.muted = true;
      video.loop = true;
      video.playsInline = true;
      video.autoplay = true;
      
      function tryPlay() {
        var playPromise = video.play();
        if (playPromise !== undefined) playPromise.catch(function() { setTimeout(tryPlay, 500); });
      }
      tryPlay();
      video.addEventListener('canplay', function() { video.play().catch(function() {}); });
      video.addEventListener('pause', function() {
        if (!state.isOpen) setTimeout(function() { video.play().catch(function() {}); }, 100);
      });
      video.addEventListener('loadeddata', function() { video.classList.remove('stories__loading'); });
    });
    
    if ('IntersectionObserver' in window) {
      var observer = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
          var video = entry.target;
          if (entry.isIntersecting) video.play().catch(function() {});
          else video.pause();
        });
      }, { threshold: 0.1 });
      videos.forEach(function(video) { observer.observe(video); });
    }
  }

  function createPopup() {
    if (state.popup) return;
    
    var overlay = document.createElement('div');
    overlay.id = 'storyPopup__' + sectionId;
    overlay.className = 'story__popup-overlay';
    
    var progressHTML = data.enableProgress ? '<div class="story__popup-progress-bar"><div class="story__popup-progress-fill"></div></div>' : '';
    var reactionsHTML = data.enableReactions ? '<div class="story__popup-reactions"><button type="button" class="story__popup-reaction" data-reaction="love" tabindex="0">‚ù§Ô∏è</button><button type="button" class="story__popup-reaction" data-reaction="fire" tabindex="0">üî•</button><button type="button" class="story__popup-reaction" data-reaction="wow" tabindex="0">üòç</button><button type="button" class="story__popup-reaction" data-reaction="share" tabindex="0">üì§</button></div>' : '';
    
    /* FIX 1 : Suppression du CTA "D√©couvrir l'offre" du popup */
    /* On ne g√©n√®re plus ctaHTML */
    
    overlay.innerHTML = '<div class="story__popup-content">' + progressHTML + '<button type="button" class="story__popup-close" aria-label="Fermer" tabindex="0"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button><div class="story__popup-video-container" style="padding-bottom: ' + data.videoType + ';"></div><h3 class="story__popup-title"></h3>' + reactionsHTML + '</div><button type="button" class="story__popup-prev" aria-label="Precedent" tabindex="0"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg></button><button type="button" class="story__popup-next" aria-label="Suivant" tabindex="0"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg></button><div class="story__popup-pause-indicator"><svg width="30" height="30" viewBox="0 0 24 24" fill="white"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg></div>';
    
    document.body.appendChild(overlay);
    state.popup = overlay;
    state.videoContainer = state.popup.querySelector('.story__popup-video-container');
    state.progressBar = state.popup.querySelector('.story__popup-progress-fill');
    
    state.popup.querySelector('.story__popup-close').addEventListener('click', closePopup);
    state.popup.querySelector('.story__popup-prev').addEventListener('click', prevStory);
    state.popup.querySelector('.story__popup-next').addEventListener('click', nextStory);
    state.popup.addEventListener('click', function(e) { if (e.target === state.popup) closePopup(); });

    if (data.enableReactions) {
      state.popup.querySelectorAll('.story__popup-reaction').forEach(function(btn) {
        btn.addEventListener('click', function(e) { handleReaction(e, btn); });
      });
    }

    state.popup.addEventListener('mouseenter', pauseProgress);
    state.popup.addEventListener('mouseleave', resumeProgress);
    setupTouchEvents();
  }

  function handleReaction(e, btn) {
    e.stopPropagation();
    var reaction = btn.dataset.reaction;
    btn.classList.add('active');
    setTimeout(function() { btn.classList.remove('active'); }, 600);
    
    if (!state.reactions[state.currentIndex]) state.reactions[state.currentIndex] = {};
    if (!state.reactions[state.currentIndex][reaction]) state.reactions[state.currentIndex][reaction] = 0;
    state.reactions[state.currentIndex][reaction]++;
    updateReactionCount(btn, state.reactions[state.currentIndex][reaction]);
    trackConversionEvent('reaction', { reaction: reaction, storyIndex: state.currentIndex, storyName: data.stories[state.currentIndex] ? data.stories[state.currentIndex].name : 'unknown' });
  }

  function updateReactionCount(btn, count) {
    var countEl = btn.querySelector('.story__reaction-count');
    if (!countEl) {
      countEl = document.createElement('span');
      countEl.className = 'story__reaction-count';
      btn.style.position = 'relative';
      btn.appendChild(countEl);
    }
    countEl.textContent = count;
  }

  /* FIX 1 : startProgress synchronis√© avec la dur√©e r√©elle de la vid√©o */
  /* La barre de progression est UNIQUEMENT visuelle, elle ne d√©clenche PLUS nextStory() */
  function startProgress(videoDuration) {
    if (!data.enableProgress || !state.progressBar) return;
    
    state.progressBar.style.width = '0%';
    state.isPaused = false;
    clearInterval(state.progressInterval);
    
    /* Si pas de dur√©e vid√©o connue, on ne lance pas la barre */
    if (!videoDuration || videoDuration <= 0 || isNaN(videoDuration) || !isFinite(videoDuration)) {
      return;
    }
    
    var progress = 0;
    var totalIntervals = (videoDuration * 1000) / 30;
    var incrementPerInterval = 100 / totalIntervals;
    
    state.progressInterval = setInterval(function() {
      if (!state.isPaused) {
        progress += incrementPerInterval;
        state.progressBar.style.width = Math.min(progress, 100) + '%';
        
        /* FIX 1 : On arr√™te juste la barre √† 100%, on ne navigue PAS */
        if (progress >= 100) {
          clearInterval(state.progressInterval);
        }
      }
    }, 30);
  }

  function pauseProgress() {
    state.isPaused = true;
    var indicator = state.popup.querySelector('.story__popup-pause-indicator');
    if (indicator) indicator.classList.add('visible');
  }

  function resumeProgress() {
    state.isPaused = false;
    var indicator = state.popup.querySelector('.story__popup-pause-indicator');
    if (indicator) indicator.classList.remove('visible');
  }

  function openPopup(index) {
    createPopup();
    state.currentIndex = index;
    state.isNavigating = false; /* FIX 1 : Reset du flag */
    
    /* FIX 2 : Sauvegarder la position de scroll AVANT d'ouvrir le popup */
    state.savedScrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    
    document.querySelectorAll('#stories__' + sectionId + ' .stories__preview-video').forEach(function(v) { v.pause(); });
    loadVideo(index);
    state.popup.classList.add('story__popup--visible');
    document.body.style.overflow = 'hidden';
    document.documentElement.style.overflow = 'hidden';
    
    /* FIX 2 : Emp√™cher le scroll de bouger quand on verrouille le body */
    document.body.style.position = 'fixed';
    document.body.style.top = '-' + state.savedScrollPosition + 'px';
    document.body.style.left = '0';
    document.body.style.right = '0';
    
    state.isOpen = true;
    updateNavigation();
    trackConversionEvent('popup_opened', { storyIndex: index, storyName: data.stories[index] ? data.stories[index].name : 'unknown' });
  }

  function closePopup() {
    if (!state.popup) return;
    state.popup.classList.remove('story__popup--visible');
    
    /* FIX 2 : Restaurer la position de scroll exacte */
    document.body.style.overflow = '';
    document.documentElement.style.overflow = '';
    document.body.style.position = '';
    document.body.style.top = '';
    document.body.style.left = '';
    document.body.style.right = '';
    
    /* FIX 2 : Remettre le scroll exactement o√π il √©tait */
    window.scrollTo(0, state.savedScrollPosition);
    
    state.isOpen = false;
    state.isNavigating = false; /* FIX 1 : Reset du flag */
    state.videoContainer.innerHTML = '';
    clearInterval(state.progressInterval);
    trackConversionEvent('popup_closed', { storyIndex: state.currentIndex, storiesViewed: getViewedStories().length });
    setTimeout(function() {
      document.querySelectorAll('#stories__' + sectionId + ' .stories__preview-video').forEach(function(v) { v.play().catch(function() {}); });
    }, 300);
  }

  /* FIX 1 : prevStory et nextStory prot√©g√©s contre le double appel */
  function prevStory() {
    if (state.isNavigating) return; /* FIX 1 : Bloquer si d√©j√† en navigation */
    if (state.currentIndex > 0) {
      state.isNavigating = true; /* FIX 1 : Verrouiller */
      clearInterval(state.progressInterval); /* FIX 1 : Arr√™ter la barre imm√©diatement */
      state.currentIndex--;
      loadVideo(state.currentIndex);
      updateNavigation();
    }
  }

  function nextStory() {
    if (state.isNavigating) return; /* FIX 1 : Bloquer si d√©j√† en navigation */
    if (state.currentIndex < data.stories.length - 1) {
      state.isNavigating = true; /* FIX 1 : Verrouiller */
      clearInterval(state.progressInterval); /* FIX 1 : Arr√™ter la barre imm√©diatement */
      state.currentIndex++;
      loadVideo(state.currentIndex);
      updateNavigation();
    } else {
      closePopup();
    }
  }

  function updateNavigation() {
    if (!state.popup) return;
    state.popup.querySelector('.story__popup-prev').style.display = state.currentIndex > 0 ? 'flex' : 'none';
    state.popup.querySelector('.story__popup-next').style.display = state.currentIndex < data.stories.length - 1 ? 'flex' : 'none';
    var titleEl = state.popup.querySelector('.story__popup-title');
    if (titleEl) titleEl.textContent = data.stories[state.currentIndex].name;
  }

  function loadVideo(index) {
    var story = data.stories[index];
    if (!story) return;
    state.videoContainer.innerHTML = '<div class="story__popup-loading"></div>';
    clearInterval(state.progressInterval);
    
    /* FIX 1 : D√©verrouiller la navigation une fois la vid√©o charg√©e */
    
    if (story.hasShopifyVideo && story.shopifyVideoUrl) {
      var videoEl = document.createElement('video');
      videoEl.src = story.shopifyVideoUrl;
      videoEl.poster = story.shopifyVideoPoster || '';
      videoEl.controls = true;
      videoEl.playsInline = true;
      videoEl.loop = data.loop;
      if (data.autoplay) { videoEl.autoplay = true; videoEl.muted = true; }
      state.videoContainer.innerHTML = '';
      state.videoContainer.appendChild(videoEl);
      if (data.autoplay) {
        videoEl.play().then(function() { setTimeout(function() { videoEl.muted = false; }, 100); }).catch(function() {});
      }
      
      /* FIX 1 : loadedmetadata pour obtenir la vraie dur√©e */
      videoEl.addEventListener('loadedmetadata', function() {
        var duration = videoEl.duration;
        startProgress(duration);
        state.isNavigating = false; /* FIX 1 : D√©verrouiller maintenant que la vid√©o est pr√™te */
        trackConversionEvent('video_loaded', { storyIndex: index, storyName: story.name, duration: duration });
      });
      
      /* FIX 1 : SEUL l'√©v√©nement 'ended' g√®re la navigation au suivant */
      videoEl.addEventListener('ended', function() {
        markStoryAsViewed(state.currentIndex);
        clearInterval(state.progressInterval);
        if (state.progressBar) state.progressBar.style.width = '100%';
        
        if (!data.loop) {
          setTimeout(function() {
            nextStory();
          }, 300);
        }
      });
      
      videoEl.addEventListener('play', function() { trackConversionEvent('video_play', { storyIndex: index, storyName: story.name }); });
      
    } else if (story.externalType === 'youtube' && story.externalId) {
      var iframe = document.createElement('iframe');
      var autoplayParam = data.autoplay ? '1' : '0';
      iframe.src = 'https://www.youtube.com/embed/' + story.externalId + '?autoplay=' + autoplayParam + '&rel=0&enablejsapi=1';
      iframe.allow = 'autoplay; encrypted-media; fullscreen';
      iframe.allowFullscreen = true;
      state.videoContainer.innerHTML = '';
      state.videoContainer.appendChild(iframe);
      state.isNavigating = false; /* FIX 1 : D√©verrouiller */
      setTimeout(function() { markStoryAsViewed(state.currentIndex); }, 1000);
      /* FIX 1 : Pas de startProgress pour YouTube/Vimeo car on ne connait pas la dur√©e */
      
    } else if (story.externalType === 'vimeo' && story.externalId) {
      var iframe = document.createElement('iframe');
      var autoplayParam = data.autoplay ? '1' : '0';
      iframe.src = 'https://player.vimeo.com/video/' + story.externalId + '?autoplay=' + autoplayParam;
      iframe.allow = 'autoplay; fullscreen';
      iframe.allowFullscreen = true;
      state.videoContainer.innerHTML = '';
      state.videoContainer.appendChild(iframe);
      state.isNavigating = false; /* FIX 1 : D√©verrouiller */
      setTimeout(function() { markStoryAsViewed(state.currentIndex); }, 1000);
    }
  }

  function setupTouchEvents() {
    var touchStartX = 0, touchEndX = 0, touchStartY = 0, touchEndY = 0;
    state.popup.addEventListener('touchstart', function(e) {
      touchStartX = e.changedTouches[0].screenX;
      touchStartY = e.changedTouches[0].screenY;
    }, { passive: true });
    state.popup.addEventListener('touchend', function(e) {
      touchEndX = e.changedTouches[0].screenX;
      touchEndY = e.changedTouches[0].screenY;
      handleSwipe();
    }, { passive: true });
    function handleSwipe() {
      var diffX = touchEndX - touchStartX;
      var diffY = touchEndY - touchStartY;
      if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
        if (diffX < 0) nextStory();
        else prevStory();
      }
    }
  }

  document.addEventListener('keydown', function(e) {
    if (!state.isOpen) return;
    switch(e.key) {
      case 'Escape': closePopup(); break;
      case 'ArrowLeft': prevStory(); break;
      case 'ArrowRight': nextStory(); break;
      case ' ':
        e.preventDefault();
        if (state.isPaused) resumeProgress();
        else pauseProgress();
        break;
    }
  });

  document.querySelectorAll('.stories__button[data-section-id="' + sectionId + '"]').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      var index = parseInt(this.getAttribute('data-story-index'), 10);
      trackConversionEvent('story_click', { storyIndex: index, storyName: data.stories[index] ? data.stories[index].name : 'unknown' });
      openPopup(index);
    });
  });

  var images = document.querySelectorAll('#stories__' + sectionId + ' img[loading="lazy"]');
  if ('IntersectionObserver' in window) {
    var imageObserver = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          var img = entry.target;
          img.addEventListener('load', function() { img.classList.remove('stories__loading'); });
          imageObserver.unobserve(img);
        }
      });
    });
    images.forEach(function(img) { imageObserver.observe(img); });
  }

  applyViewedState();
  forceAutoplayPreviews();
  initCounters();
  initProgressiveAnimations();
  initGlobalCTA();
  initStoryCTAs();
  
  if (document.readyState === 'complete') setTimeout(forceAutoplayPreviews, 100);
  else window.addEventListener('load', function() { setTimeout(forceAutoplayPreviews, 100); });
  
  ['click', 'touchstart', 'scroll'].forEach(function(event) {
    document.addEventListener(event, forceAutoplayPreviews, { once: true });
  });

  if ('IntersectionObserver' in window) {
    var sectionObserver = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          trackConversionEvent('section_viewed', { storiesCount: data.stories.length });
          sectionObserver.unobserve(entry.target);
        }
      });
    }, { threshold: 0.3 });
    var sectionEl = document.querySelector('[data-section-id="{{ section.id }}"]');
    if (sectionEl) sectionObserver.observe(sectionEl);
  }

  console.log('Stories Ultra Premium + Conversion Boosters initialises');
})();
</script>

{% schema %}
{
  "name": "Stories Ultra Premium",
  "class": "section",
  "tag": "section",
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "text",
      "id": "section_id",
      "label": "ID de section"
    },
    {
      "type": "header",
      "content": "Contenu"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Sous-titre"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Titre"
    },
    {
      "type": "select",
      "id": "heading_style",
      "options": [
        { "value": "1", "label": "Style 1" },
        { "value": "2", "label": "Style 2" },
        { "value": "3", "label": "Style 3" }
      ],
      "default": "2",
      "label": "Style du titre"
    },
    {
      "type": "inline_richtext",
      "id": "description",
      "label": "Description"
    },
    {
      "type": "select",
      "id": "alignment",
      "options": [
        { "value": "left", "label": "Gauche" },
        { "value": "center", "label": "Centre" },
        { "value": "right", "label": "Droite" }
      ],
      "default": "left",
      "label": "Alignement"
    },
    {
      "type": "header",
      "content": "Stories - Taille et espacement"
    },
    {
      "type": "range",
      "id": "story_size",
      "min": 60,
      "max": 150,
      "step": 10,
      "unit": "px",
      "label": "Taille des stories (Desktop)",
      "default": 100
    },
    {
      "type": "range",
      "id": "story_size_mobile",
      "min": 50,
      "max": 120,
      "step": 10,
      "unit": "px",
      "label": "Taille des stories (Mobile)",
      "default": 80
    },
    {
      "type": "range",
      "id": "stories_gap",
      "min": 10,
      "max": 50,
      "step": 10,
      "unit": "px",
      "label": "Espacement (Desktop)",
      "default": 20
    },
    {
      "type": "range",
      "id": "stories_gap_mobile",
      "min": 5,
      "max": 30,
      "step": 5,
      "unit": "px",
      "label": "Espacement (Mobile)",
      "default": 5
    },
    {
      "type": "checkbox",
      "id": "accent__gradient",
      "label": "Utiliser la couleur accent",
      "info": "Remplace le degrade Instagram",
      "default": false
    },
    {
      "type": "header",
      "content": "Fonctionnalites Ultra"
    },
    {
      "type": "checkbox",
      "id": "enable_reactions",
      "label": "Activer les reactions",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_progress_bar",
      "label": "Barre de progression",
      "default": true
    },
    {
      "type": "header",
      "content": "Conversion Boosters"
    },
    {
      "type": "checkbox",
      "id": "show_conversion_stats",
      "label": "Afficher les compteurs de conversion",
      "default": true
    },
    {
      "type": "range",
      "id": "stat_1_value",
      "min": 50,
      "max": 100,
      "step": 1,
      "label": "Compteur 1 - Valeur",
      "default": 97
    },
    {
      "type": "text",
      "id": "stat_1_label",
      "label": "Compteur 1 - Label",
      "default": "Clients satisfaits"
    },
    {
      "type": "range",
      "id": "stat_2_value",
      "min": 50,
      "max": 100,
      "step": 1,
      "label": "Compteur 2 - Valeur",
      "default": 93
    },
    {
      "type": "text",
      "id": "stat_2_label",
      "label": "Compteur 2 - Label",
      "default": "Recommandent"
    },
    {
      "type": "range",
      "id": "stat_3_value",
      "min": 0,
      "max": 100,
      "step": 1,
      "label": "Compteur 3 - Valeur (0 = masque)",
      "default": 0
    },
    {
      "type": "text",
      "id": "stat_3_label",
      "label": "Compteur 3 - Label",
      "default": "Resultats visibles"
    },
    {
      "type": "header",
      "content": "Temoignage Client"
    },
    {
      "type": "checkbox",
      "id": "show_testimonial",
      "label": "Afficher le temoignage",
      "default": false
    },
    {
      "type": "image_picker",
      "id": "testimonial_avatar",
      "label": "Avatar du client"
    },
    {
      "type": "textarea",
      "id": "testimonial_text",
      "label": "Texte du temoignage",
      "default": "Ces videos mont convaincue. Resultats incroyables en quelques semaines."
    },
    {
      "type": "text",
      "id": "testimonial_author",
      "label": "Nom de lauteur",
      "default": "Marie L."
    },
    {
      "type": "text",
      "id": "testimonial_role",
      "label": "Role ou statut",
      "default": "Cliente verifiee"
    },
    {
      "type": "header",
      "content": "CTA Global"
    },
    {
      "type": "checkbox",
      "id": "show_global_cta",
      "label": "Afficher le CTA global",
      "default": true
    },
    {
      "type": "text",
      "id": "global_cta_text",
      "label": "Texte du CTA",
      "default": "Decouvrir nos offres"
    },
    {
      "type": "text",
      "id": "pack_section_id",
      "label": "ID section Pack (scroll vers)",
      "default": "pack-conversion"
    },
    {
      "type": "text",
      "id": "cta_product_id",
      "label": "ID Variant produit (ajout panier)"
    },
    {
      "type": "header",
      "content": "Trust Badges"
    },
    {
      "type": "checkbox",
      "id": "show_trust_badges",
      "label": "Afficher les badges de confiance",
      "default": true
    },
    {
      "type": "header",
      "content": "Video - Parametres"
    },
    {
      "type": "select",
      "id": "type__video",
      "options": [
        { "value": "56.25%", "label": "Horizontal (16:9)" },
        { "value": "100%", "label": "Carre (1:1)" },
        { "value": "177.78%", "label": "Vertical (9:16)" }
      ],
      "default": "177.78%",
      "label": "Format de la video"
    },
    {
      "type": "checkbox",
      "id": "enable_autoplay",
      "label": "Lecture automatique",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_video_looping",
      "label": "Boucle video",
      "default": false
    },
    {
      "type": "header",
      "content": "Animations"
    },
    {
      "type": "checkbox",
      "id": "enable_animations",
      "label": "Activer les animations",
      "default": true
    },
    {
      "type": "select",
      "id": "animation",
      "options": [
        { "value": "fade-up", "label": "Fade up" },
        { "value": "fade-down", "label": "Fade down" },
        { "value": "fade-right", "label": "Fade right" },
        { "value": "fade-left", "label": "Fade left" },
        { "value": "zoom-in", "label": "Zoom in" },
        { "value": "zoom-out", "label": "Zoom out" }
      ],
      "default": "fade-up",
      "label": "Type danimation"
    },
    {
      "type": "header",
      "content": "Mise en page"
    },
    {
      "type": "select",
      "id": "layout_width",
      "options": [
        { "value": "narrow", "label": "Etroit" },
        { "value": "normal", "label": "Normal" },
        { "value": "full-padded", "label": "Pleine largeur avec padding" },
        { "value": "full", "label": "Pleine largeur" }
      ],
      "default": "full",
      "label": "Largeur"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding haut (Desktop)",
      "default": 24
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding bas (Desktop)",
      "default": 24
    },
    {
      "type": "range",
      "id": "padding_top_sm",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding haut (Mobile)",
      "default": 16
    },
    {
      "type": "range",
      "id": "padding_bottom_sm",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding bas (Mobile)",
      "default": 16
    },
    {
      "type": "header",
      "content": "Couleurs"
    },
    {
      "type": "color_scheme",
      "id": "color_palette",
      "default": "background",
      "label": "Palette de couleurs"
    },
    {
      "type": "image_picker",
      "id": "image_bg_colored",
      "label": "Image de fond"
    },
    {
      "type": "image_picker",
      "id": "image_bg_colored_mobile",
      "label": "Image de fond (Mobile)"
    },
    {
      "type": "checkbox",
      "id": "enable_cut_bg_color",
      "default": false,
      "label": "Activer fond colore"
    },
    {
      "type": "color",
      "id": "cut_bg_color",
      "default": "#F6F6F6",
      "label": "Couleur de fond"
    },
    {
      "type": "range",
      "id": "cut_bg_color_vertical",
      "min": -100,
      "max": 100,
      "step": 2,
      "unit": "%",
      "label": "Position verticale",
      "default": 0
    },
    {
      "type": "range",
      "id": "cut_bg_color_vertical_mobile",
      "min": -100,
      "max": 100,
      "step": 2,
      "unit": "%",
      "label": "Position verticale (Mobile)",
      "default": 0
    },
    {
      "type": "range",
      "id": "cut_bg_color_horizontal",
      "min": -100,
      "max": 100,
      "step": 2,
      "unit": "%",
      "label": "Position horizontale",
      "default": 0
    },
    {
      "type": "range",
      "id": "cut_bg_color_horizontal_mobile",
      "min": -100,
      "max": 100,
      "step": 2,
      "unit": "%",
      "label": "Position horizontale (Mobile)",
      "default": 0
    },
    {
      "type": "header",
      "content": "Separateurs"
    },
    {
      "type": "select",
      "id": "separator_top",
      "options": [
        { "value": "none", "label": "Aucun" },
        { "value": "wave", "label": "Vague" },
        { "value": "curve-1", "label": "Courbe 1" },
        { "value": "curve-2", "label": "Courbe 2" },
        { "value": "curve-3", "label": "Courbe 3" },
        { "value": "arrow-1", "label": "Fleche 1" },
        { "value": "arrow-2", "label": "Fleche 2" },
        { "value": "circle", "label": "Cercle" },
        { "value": "diagonal-1", "label": "Diagonal 1" },
        { "value": "diagonal-2", "label": "Diagonal 2" },
        { "value": "diagonal-3", "label": "Diagonal 3" },
        { "value": "fade", "label": "Fondu" },
        { "value": "line", "label": "Ligne" }
      ],
      "default": "none",
      "label": "Separateur haut"
    },
    {
      "type": "checkbox",
      "id": "separator_top_invert",
      "label": "Inverser separateur haut",
      "default": false
    },
    {
      "type": "select",
      "id": "separator_bottom",
      "options": [
        { "value": "none", "label": "Aucun" },
        { "value": "wave", "label": "Vague" },
        { "value": "curve-1", "label": "Courbe 1" },
        { "value": "curve-2", "label": "Courbe 2" },
        { "value": "curve-3", "label": "Courbe 3" },
        { "value": "arrow-1", "label": "Fleche 1" },
        { "value": "arrow-2", "label": "Fleche 2" },
        { "value": "circle", "label": "Cercle" },
        { "value": "diagonal-1", "label": "Diagonal 1" },
        { "value": "diagonal-2", "label": "Diagonal 2" },
        { "value": "diagonal-3", "label": "Diagonal 3" },
        { "value": "fade", "label": "Fondu" },
        { "value": "line", "label": "Ligne" }
      ],
      "default": "none",
      "label": "Separateur bas"
    },
    {
      "type": "checkbox",
      "id": "separator_bottom_invert",
      "label": "Inverser separateur bas",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "separator_animated",
      "label": "Animer les separateurs",
      "default": false
    },
    {
      "type": "color",
      "id": "separator_bg_color",
      "label": "Couleur des separateurs"
    }
  ],
  "blocks": [
    {
      "type": "story",
      "name": "Story Ultra",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image de couverture"
        },
        {
          "type": "text",
          "id": "name",
          "label": "Nom",
          "default": "@username"
        },
        {
          "type": "video",
          "id": "video",
          "label": "Video Shopify"
        },
        {
          "type": "video_url",
          "id": "video_url",
          "accept": ["youtube", "vimeo"],
          "label": "URL YouTube ou Vimeo"
        },
        {
          "type": "header",
          "content": "Options Ultra"
        },
        {
          "type": "checkbox",
          "id": "show_new_badge",
          "label": "Afficher badge NEW",
          "default": false
        },
        {
          "type": "number",
          "id": "view_count",
          "label": "Nombre de vues",
          "default": 0
        },
        {
          "type": "header",
          "content": "Conversion Boosters"
        },
        {
          "type": "checkbox",
          "id": "is_featured",
          "label": "Story en vedette (Glow)",
          "default": false
        },
        {
          "type": "checkbox",
          "id": "show_best_badge",
          "label": "Badge Meilleur choix",
          "default": false
        },
        {
          "type": "text",
          "id": "best_badge_text",
          "label": "Texte badge Meilleur choix",
          "default": "Meilleur choix"
        },
        {
          "type": "checkbox",
          "id": "is_verified",
          "label": "Badge verifie",
          "default": false
        },
        {
          "type": "checkbox",
          "id": "show_success_indicator",
          "label": "Indicateur de succes",
          "default": false
        },
        {
          "type": "checkbox",
          "id": "show_live_indicator",
          "label": "Indicateur LIVE",
          "default": false
        },
        {
          "type": "range",
          "id": "satisfaction_percent",
          "min": 0,
          "max": 100,
          "step": 1,
          "label": "Pourcentage Satisfaction (0 = masque)",
          "default": 0
        },
        {
          "type": "number",
          "id": "social_proof_count",
          "label": "Compteur social proof",
          "default": 0
        },
        {
          "type": "text",
          "id": "urgency_text",
          "label": "Texte durgence"
        },
        {
          "type": "text",
          "id": "tooltip_text",
          "label": "Tooltip au survol"
        },
        {
          "type": "text",
          "id": "cta_text",
          "label": "CTA flottant"
        },
        {
          "type": "range",
          "id": "rating",
          "min": 0,
          "max": 5,
          "step": 1,
          "label": "Note (0 = masque)",
          "default": 0
        },
        {
          "type": "number",
          "id": "rating_count",
          "label": "Nombre davis",
          "default": 0
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Stories Ultra Premium",
      "settings": {
        "heading": "Temoignages Clients",
        "subheading": "Ils nous font confiance",
        "alignment": "center",
        "enable_reactions": true,
        "enable_progress_bar": true,
        "show_conversion_stats": true,
        "stat_1_value": 97,
        "stat_1_label": "Clients satisfaits",
        "stat_2_value": 93,
        "stat_2_label": "Recommandent",
        "show_testimonial": false,
        "show_global_cta": true,
        "global_cta_text": "Decouvrir nos offres",
        "show_trust_badges": true,
        "enable_animations": true
      },
      "blocks": [
        {
          "type": "story",
          "settings": {
            "name": "@marie_beauty",
            "show_new_badge": true,
            "is_featured": true,
            "is_verified": true,
            "satisfaction_percent": 97
          }
        },
        {
          "type": "story",
          "settings": {
            "name": "@skincare_lover",
            "is_verified": true,
            "show_success_indicator": true,
            "social_proof_count": 2500
          }
        },
        {
          "type": "story",
          "settings": {
            "name": "@beauty_routine",
            "show_best_badge": true,
            "best_badge_text": "Coup de coeur",
            "rating": 5,
            "rating_count": 127
          }
        },
        {
          "type": "story",
          "settings": {
            "name": "@glow_queen",
            "is_verified": true,
            "cta_text": "Voir loffre",
            "tooltip_text": "Transformation incroyable en 4 semaines"
          }
        },
        {
          "type": "story",
          "settings": {
            "name": "@natural_skin",
            "urgency_text": "Offre limitee",
            "view_count": 3200
          }
        }
      ]
    }
  ]
}
{% endschema %}
