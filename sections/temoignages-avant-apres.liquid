{% comment %}
  Témoignages 3D Focus - Version Fusionnée
  - Slider Before/After interactif ultra-rapide
  - 7 animations desktop + 7 animations mobile attrayantes
  - Tous les paramètres du code d'origine
{% endcomment %}

{%- style -%}
  @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=Inter:wght@300;400;500;600;700&display=swap');

  #shopify-section-{{ section.id }} {
    --bg-color: {{ section.settings.bg_color }};
    --card-bg-color: {{ section.settings.card_bg_color }};
    --title-color: {{ section.settings.title_color }};
    --text-color: {{ section.settings.text_color }};
    --accent-color: {{ section.settings.accent_color | default: '#D4A574' }};
    --verified-icon-color: {{ section.settings.verified_icon_color }};
    --star-color: {{ section.settings.star_color }};
    --star-bg-color: #00B67A;
    --star-empty-color: #dcdce6;
    --product-bg-color: {{ section.settings.product_bg_color }};
    --cta-bg-color: {{ section.settings.cta_bg_color }};
    --cta-text-color: {{ section.settings.cta_text_color }};
    --arrow-color: {{ section.settings.arrow_color | default: '#1a1a1a' }};
    --dot-color: {{ section.settings.dot_color | default: '#cccccc' }};
    --dot-active-color: {{ section.settings.dot_active_color | default: '#1a1a1a' }};
    --card-border-color: {{ section.settings.card_border_color | default: '#000000' }};
    --card-border-width: {{ section.settings.card_border_width | default: 1 }}px;
    --slider-handle-color: {{ section.settings.slider_handle_color | default: '#ffffff' }};
    
    --font-heading: 'Playfair Display', Georgia, serif;
    --font-body: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    
    --card-width-desktop: {{ section.settings.card_width_desktop }}px;
    --card-height-desktop: {{ section.settings.card_height_desktop }}px;
    --card-width-mobile: {{ section.settings.card_width_mobile }}px;
    --card-height-mobile: {{ section.settings.card_height_mobile }}px;
    
    --product-padding: {{ section.settings.product_padding }}px;
    --product-img-size: {{ section.settings.product_img_size }}px;
    --product-title-size: {{ section.settings.product_title_size }}px;
    --product-subtitle-size: {{ section.settings.product_subtitle_size }}px;
    --product-btn-size: {{ section.settings.product_btn_size }}px;
    --product-border-radius: {{ section.settings.product_border_radius }}px;
  }

  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top }}px;
    padding-bottom: {{ section.settings.padding_bottom }}px;
    background-color: var(--bg-color);
    overflow: hidden;
    position: relative;
    font-family: var(--font-body);
  }

  .taa-container {
    max-width: {% if section.settings.layout_width == 'container' %}1200px{% else %}100%{% endif %};
    margin: 0 auto;
    padding: 0 20px;
    position: relative;
    text-align: {{ section.settings.alignment }};
  }

  /* NOUVEAU CODE - ESPACE RÉDUIT */
.taa-header-group {
  margin-bottom: 25px;
  {% if section.settings.alignment == 'center' %}
    margin-left: auto;
    margin-right: auto;
  {% endif %}
  max-width: 800px;
}

  .taa-subheading {
    font-family: var(--font-body);
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 3px;
    margin-bottom: 16px;
    color: var(--verified-icon-color);
    opacity: 0.9;
  }

  .taa-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: linear-gradient(135deg, #00B67A 0%, #00a06a 100%);
    color: white;
    padding: 8px 20px;
    border-radius: 50px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(0, 182, 122, 0.3);
  }

  .taa-badge svg {
    width: 14px;
    height: 14px;
  }

  .taa-title {
    font-family: var(--font-heading);
    font-size: clamp(28px, 5vw, 48px);
    font-weight: 500;
    margin-bottom: 18px;
    line-height: 1.15;
    color: var(--title-color);
    letter-spacing: -0.02em;
  }

  .taa-title em,
  .taa-title i {
    font-style: italic;
    font-weight: 400;
    color: var(--accent-color);
  }

  .taa-description {
    font-family: var(--font-body);
    font-size: 15px;
    font-weight: 400;
    opacity: 0.75;
    line-height: 1.7;
    color: var(--text-color);
    max-width: 600px;
    {% if section.settings.alignment == 'center' %}
      margin-left: auto;
      margin-right: auto;
    {% endif %}
  }

  .taa-trust-badges {
    display: flex;
    justify-content: {% if section.settings.alignment == 'center' %}center{% elsif section.settings.alignment == 'right' %}flex-end{% else %}flex-start{% endif %};
    gap: 24px;
    margin-top: 28px;
    flex-wrap: nowrap;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    padding-bottom: 5px;
  }

  .taa-trust-badges::-webkit-scrollbar {
    display: none;
  }

  .taa-trust-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: var(--font-body);
    font-size: 11px;
    font-weight: 500;
    color: var(--text-color);
    opacity: 0.85;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .taa-trust-badge-icon {
    width: 16px;
    height: 16px;
    color: var(--verified-icon-color);
    flex-shrink: 0;
  }

  /* NOUVEAU CODE - PADDING RÉDUIT */
.taa-slider-wrapper {
  display: flex;
  overflow-x: auto;
  gap: 0;
  padding: 40px calc(50% - var(--card-width-desktop) / 2) 50px;
  scroll-snap-type: x mandatory;
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
  align-items: center;
  scrollbar-width: none;
  justify-content: flex-start;
  -webkit-transform: translateZ(0);
  transform: translateZ(0);
  perspective: 1500px;
}

  .taa-slider-wrapper::-webkit-scrollbar { 
    display: none; 
  }

  /* ═══════════════════════════════════════════════════════════
     CARTES - BASE
     ═══════════════════════════════════════════════════════════ */

  .taa-card {
    flex: 0 0 var(--card-width-desktop);
    width: var(--card-width-desktop);
    height: var(--card-height-desktop);
    margin: 0 20px;
    background: var(--card-bg-color);
    border-radius: 20px;
    display: flex;
    flex-direction: row;
    overflow: hidden;
    scroll-snap-align: center;
    position: relative;
    color: var(--text-color);
    cursor: pointer;
    z-index: 1;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    will-change: transform, opacity, filter;
    border: var(--card-border-width) solid var(--card-border-color);
    transform-style: preserve-3d;
  }

  /* ═══════════════════════════════════════════════════════════
   ANIMATIONS DESKTOP - 7 TYPES (ULTRA INSTANTANÉ)
   ═══════════════════════════════════════════════════════════ */

/* TYPE 1: Smooth Elegant */
.scale-desktop-smooth .taa-card {
  opacity: 0.5;
  filter: blur(2px);
  transform: translate3d(0, 0, 0) scale3d(0.8, 0.8, 1);
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  transition: all 0.12s ease-out;
}
.scale-desktop-smooth .taa-card.active {
  opacity: 1;
  filter: blur(0);
  transform: translate3d(0, 0, 80px) scale3d(1.15, 1.15, 1);
  box-shadow: 0 60px 120px -20px rgba(0,0,0,0.35), 0 30px 60px -15px rgba(0,0,0,0.2);
  z-index: 100;
}
.scale-desktop-smooth .taa-card.adjacent {
  opacity: 0.65;
  filter: blur(1px);
  transform: translate3d(0, 0, 0) scale3d(0.9, 0.9, 1);
}

/* TYPE 2: Bounce Pop */
.scale-desktop-bounce .taa-card {
  opacity: 0.4;
  filter: blur(3px);
  transform: translate3d(0, 0, 0) scale3d(0.7, 0.7, 1);
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  transition: all 0.1s ease-out;
}
.scale-desktop-bounce .taa-card.active {
  opacity: 1;
  filter: blur(0);
  transform: translate3d(0, 0, 100px) scale3d(1.25, 1.25, 1);
  box-shadow: 0 80px 140px -25px rgba(0,0,0,0.4);
  z-index: 100;
}
.scale-desktop-bounce .taa-card.adjacent {
  opacity: 0.55;
  filter: blur(1.5px);
  transform: translate3d(0, 0, 0) scale3d(0.85, 0.85, 1);
}

/* TYPE 3: Elastic Stretch */
.scale-desktop-elastic .taa-card {
  opacity: 0.45;
  filter: blur(2px);
  transform: translate3d(0, 0, 0) scale3d(0.75, 0.75, 1);
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  transition: all 0.12s ease-out;
}
.scale-desktop-elastic .taa-card.active {
  opacity: 1;
  filter: blur(0);
  transform: translate3d(0, 0, 90px) scale3d(1.2, 1.2, 1);
  box-shadow: 0 70px 130px -20px rgba(0,0,0,0.35);
  z-index: 100;
}
.scale-desktop-elastic .taa-card.adjacent {
  opacity: 0.6;
  filter: blur(1px);
  transform: translate3d(0, 0, 0) scale3d(0.88, 0.88, 1);
}

/* TYPE 4: Slow Motion */
.scale-desktop-slow .taa-card {
  opacity: 0.5;
  filter: blur(2.5px);
  transform: translate3d(0, 0, 0) scale3d(0.78, 0.78, 1);
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  transition: all 0.15s ease-out;
}
.scale-desktop-slow .taa-card.active {
  opacity: 1;
  filter: blur(0);
  transform: translate3d(0, 0, 70px) scale3d(1.18, 1.18, 1);
  box-shadow: 0 55px 110px -18px rgba(0,0,0,0.3);
  z-index: 100;
}
.scale-desktop-slow .taa-card.adjacent {
  opacity: 0.65;
  filter: blur(1px);
  transform: translate3d(0, 0, 0) scale3d(0.92, 0.92, 1);
}

/* TYPE 5: Snap Quick */
.scale-desktop-snap .taa-card {
  opacity: 0.4;
  filter: blur(2px);
  transform: translate3d(0, 0, 0) scale3d(0.82, 0.82, 1);
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  transition: all 0.08s ease-out;
}
.scale-desktop-snap .taa-card.active {
  opacity: 1;
  filter: blur(0);
  transform: translate3d(0, 0, 85px) scale3d(1.22, 1.22, 1);
  box-shadow: 0 65px 125px -20px rgba(0,0,0,0.35);
  z-index: 100;
}
.scale-desktop-snap .taa-card.adjacent {
  opacity: 0.55;
  filter: blur(1px);
  transform: translate3d(0, 0, 0) scale3d(0.9, 0.9, 1);
}

/* TYPE 6: Fade Focus - OPTIMISÉ STYLE NUVASKIN */
.scale-desktop-fade .taa-card {
  opacity: 0.5;
  filter: blur(2px);
  transform: translate3d(0, 0, -20px) scale3d(0.85, 0.85, 1);
  box-shadow: 0 5px 15px rgba(0,0,0,0.08);
  transition: all 0.1s ease-out;
}

.scale-desktop-fade .taa-card.active {
  opacity: 1;
  filter: blur(0);
  transform: translate3d(0, 0, 20px) scale3d(1.05, 1.05, 1);
  box-shadow: 0 25px 50px rgba(0,0,0,0.15);
  z-index: 100;
  transition: all 0.1s ease-out;
}

.scale-desktop-fade .taa-card.adjacent {
  opacity: 0.5;
  filter: blur(2px);
  transform: translate3d(0, 0, 0) scale3d(0.87, 0.87, 1);
  transition: all 0.1s ease-out;
}

/* TYPE 7: Mega Zoom */
.scale-desktop-mega .taa-card {
  opacity: 0.35;
  filter: blur(4px);
  transform: translate3d(0, 0, -200px) scale3d(0.65, 0.65, 1) rotateY(15deg);
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  transition: all 0.1s ease-out;
}
.scale-desktop-mega .taa-card.active {
  opacity: 1;
  filter: blur(0);
  transform: translate3d(0, 0, 120px) scale3d(1.35, 1.35, 1) rotateY(0deg);
  box-shadow: 0 100px 180px -30px rgba(0,0,0,0.45);
  z-index: 100;
}
.scale-desktop-mega .taa-card.adjacent-left {
  opacity: 0.5;
  filter: blur(2px);
  transform: translate3d(40px, 0, -100px) scale3d(0.8, 0.8, 1) rotateY(10deg);
}
.scale-desktop-mega .taa-card.adjacent-right {
  opacity: 0.5;
  filter: blur(2px);
  transform: translate3d(-40px, 0, -100px) scale3d(0.8, 0.8, 1) rotateY(-10deg);
}

  /* ═══════════════════════════════════════════════════════════
     IMAGES - SLIDER BEFORE/AFTER INTERACTIF
     ═══════════════════════════════════════════════════════════ */

  .taa-images {
    flex: 0 0 45%;
    width: 45%;
    height: 100%;
    position: relative;
    overflow: hidden;
    background: linear-gradient(145deg, #f8f8f8, #efefef);
    cursor: col-resize;
  }

  .taa-images.single-mode {
    cursor: default;
  }

  .taa-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .taa-image.before {
    z-index: 1;
  }

  .taa-image.after {
    z-index: 2;
    clip-path: inset(0 50% 0 0);
  }

  /* Slider Handle - INSTANTANÉ */
  .taa-ba-slider {
    position: absolute;
    top: 0;
    left: 50%;
    width: 4px;
    height: 100%;
    background: var(--slider-handle-color);
    z-index: 10;
    transform: translateX(-50%);
    cursor: col-resize;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
  }

  .taa-ba-slider::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 44px;
    height: 44px;
    background: var(--slider-handle-color);
    border-radius: 50%;
    box-shadow: 0 4px 20px rgba(0,0,0,0.25);
  }

  .taa-ba-slider::after {
    content: '↔';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 16px;
    color: var(--title-color);
    font-weight: bold;
    z-index: 2;
  }

/* NOUVEAU CODE - LABELS CENTRÉS SOUS CHAQUE IMAGE */
.taa-label {
  position: absolute;
  bottom: 10px;
  padding: 5px 12px;
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(10px);
  border-radius: 50px;
  font-size: 9px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--title-color);
  z-index: 15;
  box-shadow: 0 4px 15px rgba(0,0,0,0.12);
  transform: translateX(-50%);
}

.taa-label.before {
  left: 25%;
}

.taa-label.after {
  left: 75%;
}

  /* Image combinée */
  .taa-images.single-mode .taa-image-box {
    width: 100%;
    height: 100%;
  }

  .taa-images:not(.single-mode) .taa-image-box::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to top, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0) 35%);
    z-index: 1;
    pointer-events: none;
  }

  /* ═══════════════════════════════════════════════════════════
     CONTENU
     ═══════════════════════════════════════════════════════════ */

  /* NOUVEAU CODE - CORRIGÉ */
.taa-content {
  flex: 0 0 55%;
  width: 55%;
  height: 100%;
  padding: 18px 20px;
  text-align: left;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  background: var(--card-bg-color);
  overflow: visible;
  box-sizing: border-box;
  gap: 8px;
}

.taa-content-top {
  flex: 1;
  overflow: visible;
  display: flex;
  flex-direction: column;
  min-height: 0;
  gap: 6px;
}

  .taa-author-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 14px;
    flex-wrap: nowrap;
    gap: 8px;
    flex-shrink: 0;
  }

  .taa-author-info {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .taa-author { 
    font-family: var(--font-body);
    font-weight: 600; 
    font-size: 14px; 
    color: var(--text-color);
    letter-spacing: 0.2px;
  }

  .taa-verified-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: #E8F5E9;
    color: var(--verified-icon-color);
    padding: 4px 10px;
    border-radius: 50px;
    font-size: 10px;
    font-weight: 600;
  }

  .taa-verified-badge svg {
    width: 12px;
    height: 12px;
  }

  .taa-author-age {
    font-weight: 400;
    opacity: 0.55;
    font-size: 12px;
    color: var(--text-color);
  }

  /* Étoiles */
  .taa-stars-wrapper {
    display: flex;
    align-items: center;
    gap: 4px;
    flex-shrink: 0;
  }

  .taa-stars { 
    display: flex;
    gap: 2px;
  }
  
  .taa-star-box {
    position: relative;
    width: 22px;
    height: 22px;
    min-width: 22px;
    background: var(--star-empty-color);
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
  }

  .taa-star-fill {
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    background: var(--star-bg-color);
  }

  .taa-star-icon {
    position: relative;
    z-index: 2;
    width: 14px;
    height: 14px;
    fill: #fff;
  }

  /* NOUVEAU CODE - PLUS DE LIGNES VISIBLES */
.taa-review-title { 
  font-family: var(--font-heading);
  font-size: 16px; 
  font-weight: 600; 
  margin-bottom: 6px; 
  line-height: 1.3; 
  color: var(--title-color);
  letter-spacing: -0.01em;
  flex-shrink: 0;
  overflow: visible;
}

.taa-review-text { 
  font-family: var(--font-body);
  font-size: 12px; 
  font-weight: 400;
  line-height: 1.55; 
  margin-bottom: 8px; 
  color: var(--text-color);
  opacity: 0.8;
  flex: 0 0 auto;
  overflow: visible;
}

/* FORCER L'AFFICHAGE DES TEXTES */
.taa-review-title,
.taa-review-text,
.taa-author,
.taa-author-age,
.taa-results-tag {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
  color: var(--text-color) !important;
}

.taa-review-title {
  color: var(--title-color) !important;
  font-size: 16px !important;
  margin-bottom: 8px !important;
}

.taa-review-text {
  font-size: 13px !important;
  line-height: 1.6 !important;
}

.taa-content {
  overflow: visible !important;
}

.taa-content-top {
  overflow: visible !important;
}

  /* Results Tag */
  .taa-results-tag {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
    color: #E65100;
    padding: 8px 14px;
    border-radius: 8px;
    font-size: 11px;
    font-weight: 600;
    margin-bottom: 12px;
    flex-shrink: 0;
  }

  .taa-results-tag svg {
    width: 14px;
    height: 14px;
  }

  /* Produit */
  .taa-product {
    background: var(--product-bg-color);
    border-radius: var(--product-border-radius);
    padding: var(--product-padding);
    display: flex;
    align-items: center;
    justify-content: space-between;
    border: none;
    transition: all 0.25s ease;
    gap: 8px;
    flex-shrink: 0;
    margin-top: auto;
  }

  .taa-product:hover {
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    transform: translateY(-2px);
  }

  .taa-product-left { 
    display: flex; 
    align-items: center; 
    gap: 10px;
    flex: 1;
    min-width: 0;
    overflow: hidden;
  }

  .taa-product-img { 
    width: var(--product-img-size); 
    height: var(--product-img-size); 
    min-width: var(--product-img-size);
    border-radius: 8px; 
    object-fit: cover; 
    background: #fff;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    flex-shrink: 0;
  }

  .taa-product-info { 
    display: flex; 
    flex-direction: column; 
    text-align: left; 
    gap: 2px;
    min-width: 0;
    overflow: hidden;
  }

  .taa-product-title { 
    font-family: var(--font-body);
    font-size: var(--product-title-size); 
    font-weight: 600; 
    line-height: 1.3; 
    color: var(--title-color);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .taa-product-subtitle { 
    font-family: var(--font-body);
    font-size: var(--product-subtitle-size); 
    font-weight: 400;
    opacity: 0.6; 
    color: var(--text-color);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .taa-cart-btn {
    width: var(--product-btn-size); 
    height: var(--product-btn-size);
    min-width: var(--product-btn-size);
    background: var(--title-color); 
    border-radius: 50%;
    display: flex; 
    align-items: center; 
    justify-content: center;
    color: #fff; 
    border: none; 
    cursor: pointer; 
    text-decoration: none;
    transition: all 0.25s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    flex-shrink: 0;
  }

  .taa-cart-btn svg {
    width: calc(var(--product-btn-size) * 0.45);
    height: calc(var(--product-btn-size) * 0.45);
  }

  .taa-cart-btn:hover { 
    transform: scale(1.12);
    box-shadow: 0 6px 18px rgba(0,0,0,0.18);
  }

  /* ═══════════════════════════════════════════════════════════
     NAVIGATION - RAPIDE
     ═══════════════════════════════════════════════════════════ */

  .taa-nav-btn {
    position: absolute; 
    top: 50%; 
    transform: translateY(-50%);
    width: 52px; 
    height: 52px; 
    background: #fff; 
    border-radius: 50%;
    box-shadow: 0 6px 25px rgba(0,0,0,0.12); 
    border: none; 
    cursor: pointer; 
    z-index: 20;
    display: flex; 
    align-items: center; 
    justify-content: center;
    color: var(--arrow-color);
    transition: all 0.2s ease;
  }

  .taa-nav-btn:hover { 
    transform: translateY(-50%) scale(1.15);
    box-shadow: 0 10px 35px rgba(0,0,0,0.18);
    background: var(--title-color);
    color: #fff;
  }

  .taa-nav-btn:active {
    transform: translateY(-50%) scale(1.05);
  }

  .taa-nav-btn.prev { left: 15px; }
  .taa-nav-btn.next { right: 15px; }
  
  .taa-pagination { 
    display: flex; 
    justify-content: center; 
    gap: 12px; 
    margin-top: 15px; 
  }

  .taa-dot { 
    width: 10px; 
    height: 10px; 
    background: var(--dot-color); 
    border-radius: 50%; 
    cursor: pointer; 
    transition: all 0.25s ease;
  }

  .taa-dot:hover {
    background: var(--dot-active-color);
    opacity: 0.6;
    transform: scale(1.2);
  }

  .taa-dot.active { 
    background: var(--dot-active-color); 
    transform: scale(1.5); 
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  }

  /* ═══════════════════════════════════════════════════════════
     STATISTIQUES
     ═══════════════════════════════════════════════════════════ */

  .taa-stats-bar {
    display: flex;
    justify-content: center;
    gap: 50px;
    margin-top: 50px;
    padding: 30px 0;
    border-top: 1px solid rgba(0,0,0,0.06);
    border-bottom: 1px solid rgba(0,0,0,0.06);
    flex-wrap: nowrap;
    overflow-x: auto;
    scrollbar-width: none;
  }

  .taa-stats-bar::-webkit-scrollbar {
    display: none;
  }

  .taa-stat {
    text-align: center;
    min-width: auto;
    flex-shrink: 0;
  }

  .taa-stat-number {
    font-family: var(--font-heading);
    font-size: clamp(26px, 4vw, 40px);
    font-weight: 600;
    color: var(--title-color);
    line-height: 1.1;
  }

  .taa-stat-label {
    font-family: var(--font-body);
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text-color);
    margin-top: 8px;
    opacity: 0.6;
  }

  .taa-write-review-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 14px 28px;
    background: var(--cta-bg-color);
    color: var(--cta-text-color);
    border-radius: 100px;
    text-decoration: none;
    font-family: var(--font-body);
    font-weight: 600;
    font-size: 13px;
    margin-top: 15px;
    cursor: pointer;
    border: none;
    transition: all 0.25s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }

  .taa-write-review-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.18);
  }

  /* ═══════════════════════════════════════════════════════════
     MOBILE - ANIMATIONS ATTRAYANTES
     ═══════════════════════════════════════════════════════════ */

  @media screen and (max-width: 768px) {
    .taa-header-group {
      margin-bottom: 35px;
    }

    .taa-title {
      font-size: 26px;
    }

    .taa-description {
      font-size: 14px;
    }

    .taa-trust-badges {
      justify-content: flex-start;
      gap: 16px;
      margin-top: 20px;
      padding: 0 0 8px 0;
      margin-left: -20px;
      margin-right: -20px;
      padding-left: 20px;
      padding-right: 20px;
    }

    .taa-slider-wrapper {
      gap: 0;
      padding: 60px calc(50% - var(--card-width-mobile) / 2) 70px;
    }

    .taa-card {
      flex: 0 0 var(--card-width-mobile);
      width: var(--card-width-mobile);
      height: auto;
      min-height: var(--card-height-mobile);
      flex-direction: column;
      margin: 0 12px;
      border-radius: 18px;
    }

    /* ═══════════════════════════════════════════════════════════
       ANIMATIONS MOBILE - 7 TYPES ATTRAYANTS
       ═══════════════════════════════════════════════════════════ */

    /* TYPE 1: Smooth Elegant Mobile */
    .scale-mobile-smooth .taa-card {
      opacity: 0.45;
      filter: blur(2px);
      transform: translate3d(0, 20px, 0) scale3d(0.82, 0.82, 1);
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    .scale-mobile-smooth .taa-card.active {
      opacity: 1;
      filter: blur(0);
      transform: translate3d(0, 0, 0) scale3d(1.05, 1.05, 1);
      box-shadow: 0 35px 70px -15px rgba(0,0,0,0.25);
      z-index: 10;
    }
    .scale-mobile-smooth .taa-card.adjacent {
      opacity: 0.6;
      filter: blur(1px);
      transform: translate3d(0, 10px, 0) scale3d(0.9, 0.9, 1);
    }

    /* TYPE 2: Bounce Pop Mobile - DYNAMIQUE */
    .scale-mobile-bounce .taa-card {
      opacity: 0.4;
      filter: blur(3px);
      transform: translate3d(0, 40px, 0) scale3d(0.75, 0.75, 1) rotateX(10deg);
      transition: all 0.25s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    .scale-mobile-bounce .taa-card.active {
      opacity: 1;
      filter: blur(0);
      transform: translate3d(0, -10px, 0) scale3d(1.08, 1.08, 1) rotateX(0deg);
      box-shadow: 0 50px 100px -20px rgba(0,0,0,0.35);
      z-index: 10;
    }
    .scale-mobile-bounce .taa-card.adjacent {
      opacity: 0.55;
      filter: blur(1.5px);
      transform: translate3d(0, 15px, 0) scale3d(0.85, 0.85, 1) rotateX(5deg);
    }

    /* TYPE 3: Elastic Stretch Mobile */
    .scale-mobile-elastic .taa-card {
      opacity: 0.45;
      filter: blur(2px);
      transform: translate3d(0, 30px, 0) scale3d(0.78, 0.78, 1);
      transition: all 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .scale-mobile-elastic .taa-card.active {
      opacity: 1;
      filter: blur(0);
      transform: translate3d(0, -5px, 0) scale3d(1.1, 1.1, 1);
      box-shadow: 0 45px 90px -18px rgba(0,0,0,0.3);
      z-index: 10;
    }
    .scale-mobile-elastic .taa-card.adjacent {
      opacity: 0.58;
      filter: blur(1px);
      transform: translate3d(0, 12px, 0) scale3d(0.88, 0.88, 1);
    }

    /* TYPE 4: Slow Motion Mobile */
    .scale-mobile-slow .taa-card {
      opacity: 0.5;
      filter: blur(2px);
      transform: translate3d(0, 25px, 0) scale3d(0.8, 0.8, 1);
      transition: all 0.45s cubic-bezier(0.22, 0.61, 0.36, 1);
    }
    .scale-mobile-slow .taa-card.active {
      opacity: 1;
      filter: blur(0);
      transform: translate3d(0, 0, 0) scale3d(1.06, 1.06, 1);
      box-shadow: 0 40px 80px -15px rgba(0,0,0,0.25);
      z-index: 10;
    }
    .scale-mobile-slow .taa-card.adjacent {
      opacity: 0.6;
      filter: blur(1px);
      transform: translate3d(0, 10px, 0) scale3d(0.9, 0.9, 1);
    }

    /* TYPE 5: Snap Quick Mobile - ULTRA RAPIDE */
    .scale-mobile-snap .taa-card {
      opacity: 0.4;
      filter: blur(2px);
      transform: translate3d(0, 35px, 0) scale3d(0.82, 0.82, 1);
      transition: all 0.15s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .scale-mobile-snap .taa-card.active {
      opacity: 1;
      filter: blur(0);
      transform: translate3d(0, -8px, 0) scale3d(1.08, 1.08, 1);
      box-shadow: 0 45px 90px -18px rgba(0,0,0,0.32);
      z-index: 10;
    }
    .scale-mobile-snap .taa-card.adjacent {
      opacity: 0.55;
      filter: blur(1px);
      transform: translate3d(0, 12px, 0) scale3d(0.9, 0.9, 1);
    }

    /* TYPE 6: Fade Focus Mobile */
    .scale-mobile-fade .taa-card {
      opacity: 0.3;
      filter: blur(4px);
      transform: translate3d(0, 20px, 0) scale3d(0.85, 0.85, 1);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .scale-mobile-fade .taa-card.active {
      opacity: 1;
      filter: blur(0);
      transform: translate3d(0, 0, 0) scale3d(1.04, 1.04, 1);
      box-shadow: 0 35px 70px -12px rgba(0,0,0,0.22);
      z-index: 10;
    }
    .scale-mobile-fade .taa-card.adjacent {
      opacity: 0.5;
      filter: blur(2px);
      transform: translate3d(0, 8px, 0) scale3d(0.92, 0.92, 1);
    }

    /* TYPE 7: Mega Zoom Mobile - SPECTACULAIRE */
    .scale-mobile-mega .taa-card {
      opacity: 0.35;
      filter: blur(4px);
      transform: translate3d(0, 50px, 0) scale3d(0.68, 0.68, 1) rotateX(15deg);
      transition: all 0.35s cubic-bezier(0.19, 1, 0.22, 1);
    }
    .scale-mobile-mega .taa-card.active {
      opacity: 1;
      filter: blur(0);
      transform: translate3d(0, -15px, 0) scale3d(1.15, 1.15, 1) rotateX(0deg);
      box-shadow: 0 60px 120px -25px rgba(0,0,0,0.4);
      z-index: 10;
    }
    .scale-mobile-mega .taa-card.adjacent {
      opacity: 0.5;
      filter: blur(2px);
      transform: translate3d(0, 20px, 0) scale3d(0.82, 0.82, 1) rotateX(8deg);
    }

    .taa-images { 
      flex: 0 0 200px;
      width: 100%;
      height: 200px; 
    }

    .taa-content {
      flex: 1;
      width: 100%;
      padding: 18px 16px;
    }

    .taa-ba-slider::before {
      width: 38px;
      height: 38px;
    }

    .taa-ba-slider::after {
      font-size: 14px;
    }

    .taa-label {
      padding: 5px 10px;
      font-size: 8px;
      bottom: 8px;
    }

    .taa-nav-btn { 
      display: none; 
    }

    /* Swipe hint mobile */
    .taa-swipe-hint {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-top: 15px;
      font-size: 12px;
      color: var(--text-color);
      opacity: 0.5;
      animation: swipeHintAnim 2s ease-in-out infinite;
    }

    @keyframes swipeHintAnim {
      0%, 100% { transform: translateX(0); opacity: 0.5; }
      50% { transform: translateX(10px); opacity: 0.8; }
    }

    .taa-swipe-hint svg {
      width: 16px;
      height: 16px;
    }
    
    .taa-stats-bar { 
      gap: 30px;
      padding: 25px 20px;
      margin-top: 40px;
      margin-left: -20px;
      margin-right: -20px;
      justify-content: center;
    }

    .taa-stat-number {
      font-size: 24px;
    }

    .taa-stat-label {
      font-size: 9px;
    }

    .taa-review-title {
      font-size: 16px;
    }

    .taa-review-text {
      font-size: 12px;
      -webkit-line-clamp: 4;
    }

    .taa-author {
      font-size: 12px;
    }

    .taa-star-box {
      width: 18px;
      height: 18px;
      min-width: 18px;
    }

    .taa-star-icon {
      width: 11px;
      height: 11px;
    }

    .taa-product {
      padding: calc(var(--product-padding) * 0.85);
    }

    .taa-product-img {
      width: calc(var(--product-img-size) * 0.85);
      height: calc(var(--product-img-size) * 0.85);
      min-width: calc(var(--product-img-size) * 0.85);
    }

    .taa-product-title {
      font-size: calc(var(--product-title-size) * 0.9);
    }

    .taa-product-subtitle {
      font-size: calc(var(--product-subtitle-size) * 0.9);
    }

    .taa-cart-btn {
      width: calc(var(--product-btn-size) * 0.9);
      height: calc(var(--product-btn-size) * 0.9);
      min-width: calc(var(--product-btn-size) * 0.9);
    }
  }

  @media screen and (min-width: 769px) {
    .taa-swipe-hint {
      display: none;
    }
  }
{%- endstyle -%}

<div id="{{ section.settings.section_id }}" class="section-{{ section.id }}-padding scale-desktop-{{ section.settings.scale_type_desktop }} scale-mobile-{{ section.settings.scale_type_mobile }}">
  
  {% if section.settings.separator_top != 'none' %}
    <div class="separator-top {{ section.settings.separator_top }}"></div>
  {% endif %}

  <div class="taa-container">
    
    <div class="taa-header-group">
      {% if section.settings.show_badge %}
      <div class="taa-badge">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
          <path d="M9 12l2 2 4-4"/>
        </svg>
        {{ section.settings.badge_text | default: 'Avis Vérifiés' }}
      </div>
      {% endif %}
      
      {% if section.settings.subheading != blank %}
        <div class="taa-subheading">{{ section.settings.subheading }}</div>
      {% endif %}
      {% if section.settings.title != blank %}
        <h2 class="taa-title">{{ section.settings.title }}</h2>
      {% endif %}
      {% if section.settings.description != blank %}
        <div class="taa-description">{{ section.settings.description }}</div>
      {% endif %}

      {% if section.settings.show_trust_badges %}
      <div class="taa-trust-badges">
        <div class="taa-trust-badge">
          <svg class="taa-trust-badge-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            <path d="M9 12l2 2 4-4"/>
          </svg>
          <span>{{ section.settings.trust_1 | default: 'Avis vérifiés' }}</span>
        </div>
        <div class="taa-trust-badge">
          <svg class="taa-trust-badge-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6l4 2"/>
          </svg>
          <span>{{ section.settings.trust_2 | default: 'Résultats en 28 jours' }}</span>
        </div>
        <div class="taa-trust-badge">
          <svg class="taa-trust-badge-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
          </svg>
          <span>{{ section.settings.trust_3 | default: '98% satisfaits' }}</span>
        </div>
      </div>
      {% endif %}
    </div>

    <div style="position:relative;">
      {% if section.settings.show_navigation %}
        <button class="taa-nav-btn prev" aria-label="Précédent">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 18l-6-6 6-6"/>
          </svg>
        </button>
        <button class="taa-nav-btn next" aria-label="Suivant">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 18l6-6-6-6"/>
          </svg>
        </button>
      {% endif %}

      <div class="taa-slider-wrapper" id="Slider-{{ section.id }}">
        {% for block in section.blocks %}
          {% assign rating_value = block.settings.rating %}
          {% assign rating_floor = rating_value | floor %}
          {% assign rating_next = rating_floor | plus: 1 %}
          {% assign rating_decimal = rating_value | minus: rating_floor | times: 100 | round %}
          
          <div class="taa-card {% if forloop.first %}active{% endif %}" {{ block.shopify_attributes }} data-index="{{ forloop.index0 }}">
            
            <!-- IMAGES - SLIDER BEFORE/AFTER -->
            <div class="taa-images {% if block.settings.use_single_image %}single-mode{% endif %}" data-before-after>
              {% if block.settings.use_single_image %}
                <div class="taa-image-box">
                  {% if block.settings.image_combined != blank %}
                    <img src="{{ block.settings.image_combined | image_url: width: 800 }}" class="taa-image" loading="lazy" alt="Avant Après">
                  {% else %}
                    {{ 'image' | placeholder_svg_tag: 'taa-image' }}
                  {% endif %}
                </div>
              {% else %}
                {% if block.settings.image_before != blank %}
                  <img src="{{ block.settings.image_before | image_url: width: 600 }}" class="taa-image before" loading="lazy" alt="Avant">
                {% else %}
                  <img src="https://images.unsplash.com/photo-1594824476967-48c8b964273f?w=600" class="taa-image before" alt="Avant">
                {% endif %}
                
                {% if block.settings.image_after != blank %}
                  <img src="{{ block.settings.image_after | image_url: width: 600 }}" class="taa-image after" loading="lazy" alt="Après">
                {% else %}
                  <img src="https://images.unsplash.com/photo-1531746020798-e6953c6e8e04?w=600" class="taa-image after" alt="Après">
                {% endif %}
                
                <div class="taa-ba-slider"></div>
                <span class="taa-label before">{{ block.settings.time_before | default: 'Jour 0' }}</span>
                <span class="taa-label after">{{ block.settings.time_after | default: 'Jour 28' }}</span>
              {% endif %}
            </div>

            <div class="taa-content">
  <div class="taa-content-top">
    <div class="taa-author-row">
      <div class="taa-author-info">
        <span class="taa-author">{{ block.settings.author_name | default: 'Cliente' }}</span>
        <span class="taa-verified-badge">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
          </svg>
          Vérifié
        </span>
        {% if block.settings.author_age != blank %}
        <span class="taa-author-age">• {{ block.settings.author_age }}</span>
        {% endif %}
      </div>
      
      <div class="taa-stars-wrapper">
        <div class="taa-stars">
          {% for i in (1..5) %}
            {% if i <= rating_floor %}
              {% assign fill_percent = 100 %}
            {% elsif i == rating_next %}
              {% assign fill_percent = rating_decimal %}
            {% else %}
              {% assign fill_percent = 0 %}
            {% endif %}
            
            <div class="taa-star-box">
              <div class="taa-star-fill" style="width: {{ fill_percent }}%;"></div>
              <svg class="taa-star-icon" viewBox="0 0 24 24">
                <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
              </svg>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    {% if block.settings.review_title != blank %}
      <h3 class="taa-review-title">{{ block.settings.review_title }}</h3>
    {% else %}
      <h3 class="taa-review-title">Superbe produit !</h3>
    {% endif %}
    
    {% if block.settings.review_text != blank %}
      <p class="taa-review-text">{{ block.settings.review_text }}</p>
    {% else %}
      <p class="taa-review-text">Je recommande vivement ce produit !</p>
    {% endif %}

    {% if block.settings.results_text != blank %}
    <div class="taa-results-tag">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
        <path d="M22 4L12 14.01l-3-3"/>
      </svg>
      {{ block.settings.results_text }}
    </div>
    {% endif %}
  </div>

  <div class="taa-product">
    {% if block.settings.product != blank %}
      {% assign product = block.settings.product %}
      <div class="taa-product-left">
        <img src="{{ product.featured_image | image_url: width: 100 }}" class="taa-product-img" alt="{{ product.title }}">
        <div class="taa-product-info">
          <span class="taa-product-title">{{ product.title }}</span>
          <span class="taa-product-subtitle">{{ product.price | money }}</span>
        </div>
      </div>
      <a href="{{ product.url }}" class="taa-cart-btn" aria-label="Voir le produit">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/>
          <line x1="3" y1="6" x2="21" y2="6"/>
        </svg>
      </a>
    {% else %}
      <div class="taa-product-left">
        <img src="https://cdn.shopify.com/s/files/1/0711/3274/1771/files/serum-equallyberry-au-bakuchiollatif-1001111_600x600_crop_center.png" class="taa-product-img" alt="Sérum">
        <div class="taa-product-info">
          <span class="taa-product-title">Sérum Bakuchiol</span>
          <span class="taa-product-subtitle">34,99€</span>
        </div>
      </div>
      <button class="taa-cart-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/>
          <line x1="3" y1="6" x2="21" y2="6"/>
        </svg>
      </button>
    {% endif %}
  </div>
</div>
          </div>
        {% endfor %}
      </div>
    </div>

    {% if section.settings.show_pagination %}
      <div class="taa-pagination">
        {% for block in section.blocks %}
          <div class="taa-dot {% if forloop.first %}active{% endif %}" data-index="{{ forloop.index0 }}"></div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Mobile Swipe Hint -->
    <div class="taa-swipe-hint">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 5l7 7m0 0l-7 7m7-7H3"/>
      </svg>
      Glissez pour voir plus
    </div>

    {% if section.settings.show_stats %}
    <div class="taa-stats-bar">
      <div class="taa-stat">
        <div class="taa-stat-number">{{ section.settings.stat_1_number | default: '2,500+' }}</div>
        <div class="taa-stat-label">{{ section.settings.stat_1_label | default: 'Clients satisfaits' }}</div>
      </div>
      <div class="taa-stat">
        <div class="taa-stat-number">{{ section.settings.stat_2_number | default: '4.9/5' }}</div>
        <div class="taa-stat-label">{{ section.settings.stat_2_label | default: 'Note moyenne' }}</div>
      </div>
      <div class="taa-stat">
        <div class="taa-stat-number">{{ section.settings.stat_3_number | default: '94%' }}</div>
        <div class="taa-stat-label">{{ section.settings.stat_3_label | default: 'Résultats visibles' }}</div>
      </div>
    </div>
    {% endif %}

    {% if section.settings.enable_review_submission %}
      <div style="text-align: center;">
        <button class="taa-write-review-btn" onclick="alert('Fonctionnalité de démonstration')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
          </svg>
          {{ section.settings.review_btn_text | default: 'Écrire un avis' }}
        </button>
      </div>
    {% endif %}

  </div>

  {% if section.settings.separator_bottom != 'none' %}
    <div class="separator-bottom {{ section.settings.separator_bottom }}"></div>
  {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  var slider = document.getElementById('Slider-{{ section.id }}');
  if(!slider) return;
  
  var cards = slider.querySelectorAll('.taa-card');
  var dots = document.querySelectorAll('.taa-dot');
  var prevBtn = slider.parentElement.querySelector('.prev');
  var nextBtn = slider.parentElement.querySelector('.next');
  var enableActiveCard = {{ section.settings.enable_active_card | default: true }};
  
  var isScrolling = false;
  var scrollTimeout;
  var lastActiveIndex = 0;

  // ═══════════════════════════════════════════════════════════
  // NAVIGATION RAPIDE - CLIC SUR CARTE
  // ═══════════════════════════════════════════════════════════
  
  cards.forEach(function(card) {
    card.addEventListener('click', function(e) {
      if (e.target.closest('.taa-images[data-before-after]:not(.single-mode)')) return;
      var cardCenter = card.offsetLeft + (card.offsetWidth / 2);
      var sliderCenter = slider.offsetWidth / 2;
      slider.scrollTo({
        left: cardCenter - sliderCenter,
        behavior: 'smooth'
      });
    });
  });

  // ═══════════════════════════════════════════════════════════
  // UPDATE ACTIVE - OPTIMISÉ
  // ═══════════════════════════════════════════════════════════

  function updateActive() {
    var center = slider.scrollLeft + (slider.offsetWidth / 2);
    var closest = null;
    var minDist = Infinity;
    var activeIndex = 0;

    cards.forEach(function(card, i) {
      var cardLeft = card.offsetLeft;
      var cardWidth = card.offsetWidth;
      var cardCenter = cardLeft + cardWidth / 2;
      var dist = Math.abs(cardCenter - center);

      if(dist < minDist) { 
        minDist = dist; 
        closest = card; 
        activeIndex = i; 
      }
    });

    if (activeIndex === lastActiveIndex && slider.querySelector('.taa-card.active')) {
      return;
    }
    lastActiveIndex = activeIndex;

    if (enableActiveCard) {
      cards.forEach(function(c) { 
        c.classList.remove('active', 'adjacent', 'adjacent-left', 'adjacent-right'); 
      });
      
      if(closest) closest.classList.add('active');

      if(activeIndex > 0) {
        cards[activeIndex - 1].classList.add('adjacent', 'adjacent-left');
      }
      if(activeIndex < cards.length - 1) {
        cards[activeIndex + 1].classList.add('adjacent', 'adjacent-right');
      }

      dots.forEach(function(d) { d.classList.remove('active'); });
      if(dots[activeIndex]) dots[activeIndex].classList.add('active');
    }
  }

  // ═══════════════════════════════════════════════════════════
  // SCROLL LISTENER - THROTTLED
  // ═══════════════════════════════════════════════════════════

  slider.addEventListener('scroll', function() {
    if (!isScrolling) {
      window.requestAnimationFrame(function() {
        updateActive();
        isScrolling = false;
      });
      isScrolling = true;
    }
  }, { passive: true });

  updateActive();

  // ═══════════════════════════════════════════════════════════
  // NAVIGATION BUTTONS - RAPIDE
  // ═══════════════════════════════════════════════════════════

  if(prevBtn) {
    prevBtn.addEventListener('click', function() {
      var activeIndex = Array.from(cards).findIndex(function(c) { return c.classList.contains('active'); });
      var targetIndex = activeIndex > 0 ? activeIndex - 1 : cards.length - 1;
      var card = cards[targetIndex];
      var cardCenter = card.offsetLeft + (card.offsetWidth / 2);
      var sliderCenter = slider.offsetWidth / 2;
      slider.scrollTo({
        left: cardCenter - sliderCenter,
        behavior: 'smooth'
      });
    });
  }
  
  if(nextBtn) {
    nextBtn.addEventListener('click', function() {
      var activeIndex = Array.from(cards).findIndex(function(c) { return c.classList.contains('active'); });
      var targetIndex = activeIndex < cards.length - 1 ? activeIndex + 1 : 0;
      var card = cards[targetIndex];
      var cardCenter = card.offsetLeft + (card.offsetWidth / 2);
      var sliderCenter = slider.offsetWidth / 2;
      slider.scrollTo({
        left: cardCenter - sliderCenter,
        behavior: 'smooth'
      });
    });
  }
  
  dots.forEach(function(dot, i) {
    dot.addEventListener('click', function() {
      var card = cards[i];
      var cardCenter = card.offsetLeft + (card.offsetWidth / 2);
      var sliderCenter = slider.offsetWidth / 2;
      slider.scrollTo({
        left: cardCenter - sliderCenter,
        behavior: 'smooth'
      });
    });
  });

  // ═══════════════════════════════════════════════════════════
  // BEFORE/AFTER SLIDER - INSTANTANÉ
  // ═══════════════════════════════════════════════════════════

  var baContainers = document.querySelectorAll('.taa-images[data-before-after]:not(.single-mode)');

  baContainers.forEach(function(container) {
    var sliderHandle = container.querySelector('.taa-ba-slider');
    var afterImage = container.querySelector('.taa-image.after');
    var isDragging = false;

    if (!sliderHandle || !afterImage) return;

    function updateSliderPosition(x) {
      var rect = container.getBoundingClientRect();
      var percent = ((x - rect.left) / rect.width) * 100;
      percent = Math.max(0, Math.min(100, percent));
      
      // INSTANTANÉ - pas de transition
      sliderHandle.style.left = percent + '%';
      afterImage.style.clipPath = 'inset(0 ' + (100 - percent) + '% 0 0)';
    }

    // Mouse events
    container.addEventListener('mousedown', function(e) {
      isDragging = true;
      updateSliderPosition(e.clientX);
      e.preventDefault();
      e.stopPropagation();
    });

    document.addEventListener('mousemove', function(e) {
      if (isDragging) {
        updateSliderPosition(e.clientX);
      }
    });

    document.addEventListener('mouseup', function() {
      isDragging = false;
    });

    // Touch events
    container.addEventListener('touchstart', function(e) {
      isDragging = true;
      updateSliderPosition(e.touches[0].clientX);
      e.stopPropagation();
    }, { passive: true });

    container.addEventListener('touchmove', function(e) {
      if (isDragging) {
        updateSliderPosition(e.touches[0].clientX);
        e.preventDefault();
      }
    }, { passive: false });

    container.addEventListener('touchend', function() {
      isDragging = false;
    });
  });

  // ═══════════════════════════════════════════════════════════
  // AUTOPLAY
  // ═══════════════════════════════════════════════════════════

  var autoplayEnabled = {{ section.settings.enable_autoplay | default: false }};
  if(autoplayEnabled && nextBtn) {
    setInterval(function() {
      nextBtn.click();
    }, {{ section.settings.autoplay_delay | default: 5 | times: 1000 }});
  }
});
</script>

{% schema %}
{
  "name": "Témoignages 3D B/A",
  "settings": [
    {
      "type": "text",
      "id": "section_id",
      "label": "ID de section"
    },
    {
      "type": "header",
      "content": "EN-TÊTE"
    },
    {
      "type": "checkbox",
      "id": "show_badge",
      "label": "Afficher le badge",
      "default": true
    },
    {
      "type": "text",
      "id": "badge_text",
      "label": "Texte du badge",
      "default": "Avis Vérifiés"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Sous-titre"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Titre",
      "default": "Nos clientes <em>témoignent</em>"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description"
    },
    {
      "type": "select",
      "id": "alignment",
      "label": "Alignement",
      "options": [
        { "value": "left", "label": "Gauche" },
        { "value": "center", "label": "Centre" },
        { "value": "right", "label": "Droite" }
      ],
      "default": "center"
    },
    {
      "type": "header",
      "content": "BADGES DE CONFIANCE"
    },
    {
      "type": "checkbox",
      "id": "show_trust_badges",
      "label": "Afficher les badges",
      "default": true
    },
    {
      "type": "text",
      "id": "trust_1",
      "label": "Badge 1",
      "default": "Avis vérifiés"
    },
    {
      "type": "text",
      "id": "trust_2",
      "label": "Badge 2",
      "default": "Résultats en 28 jours"
    },
    {
      "type": "text",
      "id": "trust_3",
      "label": "Badge 3",
      "default": "98% satisfaits"
    },
    {
      "type": "header",
      "content": "ANIMATIONS SCALE"
    },
    {
      "type": "select",
      "id": "scale_type_desktop",
      "label": "Animation Desktop",
      "options": [
        { "value": "smooth", "label": "1. Smooth Elegant" },
        { "value": "bounce", "label": "2. Bounce Pop" },
        { "value": "elastic", "label": "3. Elastic Stretch" },
        { "value": "slow", "label": "4. Slow Motion" },
        { "value": "snap", "label": "5. Snap Quick" },
        { "value": "fade", "label": "6. Fade Focus" },
        { "value": "mega", "label": "7. Mega Zoom" }
      ],
      "default": "smooth"
    },
    {
      "type": "select",
      "id": "scale_type_mobile",
      "label": "Animation Mobile",
      "options": [
        { "value": "smooth", "label": "1. Smooth Elegant" },
        { "value": "bounce", "label": "2. Bounce Pop" },
        { "value": "elastic", "label": "3. Elastic Stretch" },
        { "value": "slow", "label": "4. Slow Motion" },
        { "value": "snap", "label": "5. Snap Quick" },
        { "value": "fade", "label": "6. Fade Focus" },
        { "value": "mega", "label": "7. Mega Zoom" }
      ],
      "default": "bounce"
    },
    {
      "type": "header",
      "content": "TAILLE CARTES DESKTOP"
    },
    {
      "type": "range",
      "id": "card_width_desktop",
      "min": 500,
      "max": 900,
      "step": 10,
      "unit": "px",
      "label": "Largeur",
      "default": 650
    },
    {
      "type": "range",
      "id": "card_height_desktop",
      "min": 300,
      "max": 550,
      "step": 10,
      "unit": "px",
      "label": "Hauteur",
      "default": 400
    },
    {
      "type": "header",
      "content": "TAILLE CARTES MOBILE"
    },
    {
      "type": "range",
      "id": "card_width_mobile",
      "min": 260,
      "max": 380,
      "step": 5,
      "unit": "px",
      "label": "Largeur",
      "default": 300
    },
    {
      "type": "range",
      "id": "card_height_mobile",
      "min": 420,
      "max": 650,
      "step": 10,
      "unit": "px",
      "label": "Hauteur",
      "default": 520
    },
    {
      "type": "header",
      "content": "PRODUIT ASSOCIÉ"
    },
    {
      "type": "range",
      "id": "product_padding",
      "min": 6,
      "max": 20,
      "step": 2,
      "unit": "px",
      "label": "Espacement",
      "default": 12
    },
    {
      "type": "range",
      "id": "product_img_size",
      "min": 28,
      "max": 60,
      "step": 2,
      "unit": "px",
      "label": "Taille image",
      "default": 44
    },
    {
      "type": "range",
      "id": "product_title_size",
      "min": 9,
      "max": 14,
      "step": 1,
      "unit": "px",
      "label": "Taille titre",
      "default": 12
    },
    {
      "type": "range",
      "id": "product_subtitle_size",
      "min": 8,
      "max": 12,
      "step": 1,
      "unit": "px",
      "label": "Taille sous-titre",
      "default": 11
    },
    {
      "type": "range",
      "id": "product_btn_size",
      "min": 26,
      "max": 50,
      "step": 2,
      "unit": "px",
      "label": "Taille bouton",
      "default": 38
    },
    {
      "type": "range",
      "id": "product_border_radius",
      "min": 6,
      "max": 20,
      "step": 2,
      "unit": "px",
      "label": "Arrondi",
      "default": 12
    },
    {
      "type": "header",
      "content": "STATISTIQUES"
    },
    {
      "type": "checkbox",
      "id": "show_stats",
      "label": "Afficher les stats",
      "default": true
    },
    {
      "type": "text",
      "id": "stat_1_number",
      "label": "Stat 1 Chiffre",
      "default": "1,523+"
    },
    {
      "type": "text",
      "id": "stat_1_label",
      "label": "Stat 1 Label",
      "default": "Clientes satisfaites"
    },
    {
      "type": "text",
      "id": "stat_2_number",
      "label": "Stat 2 Chiffre",
      "default": "4.8/5"
    },
    {
      "type": "text",
      "id": "stat_2_label",
      "label": "Stat 2 Label",
      "default": "Note moyenne"
    },
    {
      "type": "text",
      "id": "stat_3_number",
      "label": "Stat 3 Chiffre",
      "default": "94%"
    },
    {
      "type": "text",
      "id": "stat_3_label",
      "label": "Stat 3 Label",
      "default": "Résultats visibles"
    },
    {
      "type": "header",
      "content": "BOUTON AVIS"
    },
    {
      "type": "checkbox",
      "id": "enable_review_submission",
      "label": "Afficher bouton",
      "default": false
    },
    {
      "type": "text",
      "id": "review_btn_text",
      "label": "Texte bouton",
      "default": "Écrire un avis"
    },
    {
      "type": "header",
      "content": "NAVIGATION"
    },
    {
      "type": "checkbox",
      "id": "show_navigation",
      "label": "Flèches",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_pagination",
      "label": "Points",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_active_card",
      "label": "Effet carte active",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_autoplay",
      "label": "Défilement auto",
      "default": false
    },
    {
      "type": "range",
      "id": "autoplay_delay",
      "min": 2,
      "max": 10,
      "step": 1,
      "unit": "s",
      "label": "Délai autoplay",
      "default": 5
    },
    {
      "type": "header",
      "content": "MISE EN PAGE"
    },
    {
      "type": "select",
      "id": "layout_width",
      "label": "Largeur",
      "options": [
        { "value": "container", "label": "Conteneur" },
        { "value": "full", "label": "Pleine largeur" }
      ],
      "default": "container"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 120,
      "step": 4,
      "unit": "px",
      "label": "Espacement haut",
      "default": 80
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 120,
      "step": 4,
      "unit": "px",
      "label": "Espacement bas",
      "default": 80
    },
    {
      "type": "header",
      "content": "COULEURS"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Fond section",
      "default": "#FAF9F6"
    },
    {
      "type": "color",
      "id": "card_bg_color",
      "label": "Fond cartes",
      "default": "#FFFFFF"
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Couleur titres",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Couleur textes",
      "default": "#555555"
    },
    {
      "type": "color",
      "id": "accent_color",
      "label": "Couleur accent",
      "default": "#D4A574"
    },
    {
      "type": "color",
      "id": "verified_icon_color",
      "label": "Icône vérifié",
      "default": "#00B67A"
    },
    {
      "type": "color",
      "id": "star_color",
      "label": "Couleur étoiles",
      "default": "#00B67A"
    },
    {
      "type": "color",
      "id": "arrow_color",
      "label": "Couleur flèches",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "dot_color",
      "label": "Points inactifs",
      "default": "#cccccc"
    },
    {
      "type": "color",
      "id": "dot_active_color",
      "label": "Point actif",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "product_bg_color",
      "label": "Fond produit",
      "default": "#F8F7F4"
    },
    {
      "type": "color",
      "id": "cta_bg_color",
      "label": "Fond bouton CTA",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "cta_text_color",
      "label": "Texte bouton CTA",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "card_border_color",
      "label": "Bordure cartes",
      "default": "#000000"
    },
    {
      "type": "range",
      "id": "card_border_width",
      "min": 0,
      "max": 4,
      "step": 1,
      "unit": "px",
      "label": "Épaisseur bordure",
      "default": 1
    },
    {
      "type": "color",
      "id": "slider_handle_color",
      "label": "Couleur slider B/A",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "SÉPARATEURS"
    },
    {
      "type": "select",
      "id": "separator_top",
      "label": "Séparateur haut",
      "options": [
        { "value": "none", "label": "Aucun" },
        { "value": "wave", "label": "Vague" }
      ],
      "default": "none"
    },
    {
      "type": "select",
      "id": "separator_bottom",
      "label": "Séparateur bas",
      "options": [
        { "value": "none", "label": "Aucun" },
        { "value": "wave", "label": "Vague" }
      ],
      "default": "none"
    }
  ],
  "blocks": [
    {
      "type": "testimonial",
      "name": "Témoignage",
      "settings": [
        {
          "type": "header",
          "content": "IMAGES"
        },
        {
          "type": "checkbox",
          "id": "use_single_image",
          "label": "Image unique combinée",
          "default": false
        },
        {
          "type": "image_picker",
          "id": "image_combined",
          "label": "Image combinée"
        },
        {
          "type": "image_picker",
          "id": "image_before",
          "label": "Image AVANT"
        },
        {
          "type": "text",
          "id": "time_before",
          "label": "Label Avant",
          "default": "Jour 0"
        },
        {
          "type": "image_picker",
          "id": "image_after",
          "label": "Image APRÈS"
        },
        {
          "type": "text",
          "id": "time_after",
          "label": "Label Après",
          "default": "Jour 28"
        },
        {
          "type": "header",
          "content": "AUTEUR"
        },
        {
          "type": "text",
          "id": "author_name",
          "label": "Nom",
          "default": "Claire M."
        },
        {
          "type": "text",
          "id": "author_age",
          "label": "Âge",
          "default": "47 ans"
        },
        {
          "type": "range",
          "id": "rating",
          "min": 1,
          "max": 5,
          "step": 1,
          "label": "Note",
          "default": 5
        },
        {
          "type": "header",
          "content": "AVIS"
        },
        {
          "type": "text",
          "id": "review_title",
          "label": "Titre de l'avis",
          "default": "Superbe produit, résultats visibles !"
        },
        {
          "type": "textarea",
          "id": "review_text",
          "label": "Texte de l'avis",
          "default": "Voici ma photo d'avant et d'après — une très grande différence ! Le produit est superbe. Ma peau est plus lisse, plus ferme. Je recommande vivement !"
        },
        {
          "type": "text",
          "id": "results_text",
          "label": "Tag résultats",
          "default": "Résultats visibles en 28 jours"
        },
        {
          "type": "header",
          "content": "PRODUIT"
        },
        {
          "type": "product",
          "id": "product",
          "label": "Produit associé"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Témoignages 3D B/A",
      "blocks": [
        { "type": "testimonial" },
        { "type": "testimonial" },
        { "type": "testimonial" },
        { "type": "testimonial" }
      ]
    }
  ]
}
{% endschema %}