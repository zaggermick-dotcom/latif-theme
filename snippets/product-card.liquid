{{ 'component-product-card.css' | asset_url | stylesheet_tag }}

<script>
  class ProductCardPriceUpdater {
    constructor(select) {
      this.select = select;
      this.productCard = select.closest('.product-card');
      this.priceContainer = this.productCard.querySelector('.product-card__price');
      this.form = select.closest('form');
      this.productUrl = this.productCard.querySelector('.product-card__link').href;
      
      this.select.addEventListener('change', this.onVariantChange.bind(this));
    }

    async onVariantChange() {
      const variantId = this.select.value;
      
      try {
        // Faire une requête AJAX vers la page du produit avec la variante sélectionnée
        const response = await fetch(`${this.productUrl}?variant=${variantId}`);
        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Trouver le conteneur de prix dans la réponse
        const newPriceContainer = doc.querySelector('.product__info-container .price');
        
        if (newPriceContainer) {
          let regularPrice = null;
          let finalPrice = null;

          // Cas 1: Prix en solde (price__sale présent)
          if (newPriceContainer.classList.contains('price--on-sale')) {
            regularPrice = newPriceContainer.querySelector('.price-item--regular')?.textContent.trim();
            finalPrice = newPriceContainer.querySelector('.price-item--sale')?.textContent.trim();
          }
          // Cas 2: Prix régulier (price__regular présent)
          else {
            finalPrice = newPriceContainer.querySelector('.price-item--regular')?.textContent.trim();
          }

          console.log('Prix récupérés:', { regularPrice, finalPrice });
          // Mettre à jour les prix
          this.updatePrices(regularPrice, finalPrice);
        }
      } catch (error) {
        console.error('Erreur lors de la mise à jour du prix:', error);
      }
    }

    updatePrices(regularPrice, finalPrice) {
      const priceElement = this.priceContainer.querySelector('.price');
      let regularPriceElement = this.priceContainer.querySelector('.price-item--regular');
      const finalPriceElement = this.priceContainer.querySelector('.price-item--final');

      // Mettre à jour le prix final
      if (finalPriceElement && finalPrice) {
        finalPriceElement.textContent = finalPrice;
      }

      // Gérer le prix barré
      if (regularPrice) {
        // Il y a un prix barré
        priceElement.classList.add('price--on-sale');
        
        if (!regularPriceElement) {
          // Créer l'élément de prix barré s'il n'existe pas
          regularPriceElement = document.createElement('s');
          regularPriceElement.classList.add('price-item', 'price-item--regular');
          priceElement.insertBefore(regularPriceElement, finalPriceElement);
        }
        regularPriceElement.textContent = regularPrice;
      } else {
        // Pas de prix barré
        priceElement.classList.remove('price--on-sale');
        regularPriceElement?.remove();
      }
    }
  }

  // Initialiser pour tous les sélecteurs de variantes
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.product-card .select__select').forEach(select => {
      new ProductCardPriceUpdater(select);
    });

    // Gérer les changements de variantes pour les checkboxes cross-sell
    document.addEventListener('change', (e) => {
      if (e.target.classList.contains('product-card__variant-select')) {
        const productId = e.target.dataset.productId;
        const variantId = e.target.value;
        const checkbox = e.target.closest('.product-card__checkbox-container').querySelector('.product-card__checkbox');
        
        if (checkbox) {
          checkbox.dataset.variantId = variantId;
        }
      }
    });
  });
</script>

{%- if product != blank -%}
  <div class="product-card{% if block.settings.cards_layout == 'row' %} product-card--row{% endif %}">
    <div class="product-card__media">
      <a href="{{ product.url }}" class="product-card__link">
        {%- if product.featured_media -%}
          <img
            srcset="{%- if product.featured_media.width >= 165 -%}{{ product.featured_media | image_url: width: 165 }} 165w,{%- endif -%}
              {%- if product.featured_media.width >= 360 -%}{{ product.featured_media | image_url: width: 360 }} 360w,{%- endif -%}
              {%- if product.featured_media.width >= 533 -%}{{ product.featured_media | image_url: width: 533 }} 533w,{%- endif -%}
              {%- if product.featured_media.width >= 720 -%}{{ product.featured_media | image_url: width: 720 }} 720w,{%- endif -%}
              {%- if product.featured_media.width >= 940 -%}{{ product.featured_media | image_url: width: 940 }} 940w,{%- endif -%}
              {%- if product.featured_media.width >= 1066 -%}{{ product.featured_media | image_url: width: 1066 }} 1066w,{%- endif -%}"
            src="{{ product.featured_media | image_url: width: 533 }}"
            sizes="(min-width: 1100px) 535px, (min-width: 750px) calc((100vw - 130px) / 2), calc((100vw - 50px) / 2)"
            alt="{{ product.featured_media.alt | escape }}"
            loading="lazy"
            width="{{ product.featured_media.width }}"
            height="{{ product.featured_media.height }}"
            class="product-card__image"
          >
        {%- else -%}
          {{ 'product-1' | placeholder_svg_tag: 'product-card__image placeholder' }}
        {%- endif -%}
      </a>

      {% comment %}
        {%- if product.available == false -%}
        <span class="product-card__badge">
          {{- 'products.product.sold_out' | t -}}
        </span>
      {%- elsif product.compare_at_price > product.price -%}
        <span class="product-card__badge">
          {{- 'products.product.on_sale' | t -}}
        </span>
      {%- endif -%}
      {% endcomment %}
    </div>

    <div class="product-card__content">
      <a href="{{ product.url }}" class="product-card__link">
        <h3 class="product-card__title">
          {{ product.title }}
        </h3>

        <div class="product-card__price price__color--{{ block.settings.price_color }}">
          {%- if product.available -%}
            {% style %}
              .product-card .price {
                display: flex;
                align-items: center;
                justify-content: center;
                flex-direction: column;
                gap: 0;
              }

              .product-card .price:not(.price--on-sale) .price-item--final,
              .product-card .price.price--on-sale .price-item--final {
                font-size: calc(1.6rem * {{ block.settings.price_font_size | divided_by: 100.0 }});
                order: 2;
              }

              .product-card .price--on-sale .price-item--regular {
                font-size: calc(1.6rem * {{ block.settings.price_font_size_sale | divided_by: 100.0 }});
                order: 1;
                margin: 0;
              }
            {% endstyle %}
            <span class="price{% if product.compare_at_price > product.price %} price--on-sale{% endif %}">
              {%- if product.compare_at_price > product.price -%}
                <s class="price-item price-item--regular">
                  {{ product.compare_at_price | money }}
                </s>
              {%- endif -%}
              <span class="price-item price-item--final">
                {{ product.price | money }}
              </span>
            </span>
          {%- else -%}
            <span class="price">
              <span class="price-item">
                {{ 'products.product.sold_out' | t }}
              </span>
            </span>
          {%- endif -%}
        </div>
      </a>

      {%- if product.available -%}
        {%- if block.settings.checkbox_mode -%}
          <!-- Mode checkbox -->
          <div class="product-card__checkbox-container">
            {%- unless product.has_only_default_variant -%}
              <div class="product-card__variants">
                <div class="select">
                  <select
                    class="select__select product-card__variant-select"
                    data-product-id="{{ product.id }}"
                  >
                  {%- for variant in product.variants -%}
                    <option
                      value="{{ variant.id }}"
                      {% if variant == product.selected_or_first_available_variant %}selected="selected"{% endif %}
                      {% unless variant.available %}disabled{% endunless %}
                    >
                      {{ variant.title }}
                      {%- if variant.available -%}
                        - {{ variant.price | money }}
                      {%- else -%}
                        - {{ 'products.product.sold_out' | t }}
                      {%- endif -%}
                    </option>
                  {%- endfor -%}
                  </select>
                  {%- render 'icon-caret' -%}
                </div>
              </div>
            {%- endunless -%}
            
            <label class="product-card__checkbox-label">
              <input 
                type="checkbox" 
                class="product-card__checkbox"
                data-product-id="{{ product.id }}"
                data-variant-id="{{ product.selected_or_first_available_variant.id }}"
                {% unless product.selected_or_first_available_variant.available %}disabled{% endunless %}
              >
            </label>
          </div>
        {%- else -%}
          <!-- Mode bouton ATC classique -->
          {%- assign product_form_id = 'product-form-' | append: product.id -%}
          <product-form class="product-form">
            {%- form 'product',
              product,
              id: product_form_id,
              class: 'form',
              novalidate: 'novalidate'
            -%}
              {%- unless product.has_only_default_variant -%}
                <div class="product-card__variants">
                  <div class="select">
                    <select
                      name="id"
                      class="select__select"
                      data-product-select
                    >
                    {%- for variant in product.variants -%}
                      <option
                        value="{{ variant.id }}"
                        {% if variant == product.selected_or_first_available_variant %}selected="selected"{% endif %}
                        {% unless variant.available %}disabled{% endunless %}
                      >
                        {{ variant.title }}
                        {%- if variant.available -%}
                          - {{ variant.price | money }}
                        {%- else -%}
                          - {{ 'products.product.sold_out' | t }}
                        {%- endif -%}
                      </option>
                    {%- endfor -%}
                    </select>
                    {%- render 'icon-caret' -%}
                  </div>
                </div>
              {%- else -%}
                <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
              {%- endunless -%}
              <input type="hidden" name="quantity" value="1">
              <input type="hidden" name="sections" value="cart-notification-product,cart-notification-button,cart-icon-bubble,cart-live-region-text,cart-drawer">
              <input type="hidden" name="sections_url" value="{{ request.path }}">

              <button
                type="submit"
                name="add"
                class="product__add-to-cart product-form__submit button product-card__button button__style--{{ block.settings.button_style }}"
                {% if product.selected_or_first_available_variant.available == false %}disabled{% endif %}
                {% if settings.cart_type == 'notification' %}
                  data-cart-notification="{{ product_form_id }}"
                {% elsif settings.cart_type == 'drawer' %}
                  data-cart-drawer-trigger
                {% endif %}
              >
                <span class="product-card__button-text">
                  {%- if product.selected_or_first_available_variant.available -%}
                    {{ block.settings.button_text }}
                  {%- else -%}
                    {{ 'products.product.sold_out' | t }}
                  {%- endif -%}
                </span>
                <span class="loading-overlay__spinner hidden">
                  <svg aria-hidden="true" focusable="false" class="spinner" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                    <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
                  </svg>
                </span>
              </button>

              {%- if product.has_only_default_variant == false -%}
                <script type="application/json">
                  {
                    "id": {{ product.id | json }},
                    "variants": {{ product.variants | json }},
                    "options": {{ product.options | json }},
                    "url": {{ product.url | json }}
                  }
                </script>
              {%- endif -%}
            {%- endform -%}
          </product-form>
        {%- endif -%}
      {%- else -%}
        <button type="button" class="product__add-to-cart product-form__submit button product-card__button button__style--{{ block.settings.button_style }}" disabled>
          {{ 'products.product.sold_out' | t }}
        </button>
      {%- endif -%}
    </div>
  </div>
{%- endif -%}
