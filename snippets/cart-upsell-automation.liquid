{%- comment -%}
  Snippet: cart-upsell-automation.liquid
  Description: Syst√®me d'upsell intelligent dans le panier
  Utilise les tags produits et m√©tafields pour des recommandations personnalis√©es
  Compatible avec Shopify Flow pour automatiser les recommandations
  
  Usage:
    {% render 'cart-upsell-automation' %}
{%- endcomment -%}

{%- liquid
  assign show_upsells = true
  assign max_upsells = 3
  assign upsell_products = ''
  
  # Collecter les produits du panier
  assign cart_product_ids = ''
  assign cart_tags = ''
  for item in cart.items
    assign cart_product_ids = cart_product_ids | append: item.product.id | append: ','
    assign cart_tags = cart_tags | append: item.product.tags | join: ',' | append: ','
  endfor
  
  # D√©tecter la cat√©gorie principale du panier
  assign has_skincare = false
  assign has_serum = false
  assign has_routine = false
  
  if cart_tags contains 'skincare' or cart_tags contains 'soin'
    assign has_skincare = true
  endif
  
  if cart_tags contains 'serum' or cart_tags contains 's√©rum'
    assign has_serum = true
  endif
  
  if cart_tags contains 'routine'
    assign has_routine = true
  endif
-%}

{%- if show_upsells and cart.item_count > 0 -%}
  <div class="cart-upsell-automation" data-cart-upsell>
    <div class="cart-upsell-header">
      <h3 class="cart-upsell-title">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
        {{ 'Compl√©tez votre routine' }}
      </h3>
      <p class="cart-upsell-subtitle">Produits recommand√©s pour vous</p>
    </div>
    
    <div class="cart-upsell-products">
      {%- comment -%} Upsell bas√© sur les collections compl√©mentaires {%- endcomment -%}
      {%- if settings.upsell_collection != blank -%}
        {%- for product in settings.upsell_collection.products limit: max_upsells -%}
          {%- unless cart_product_ids contains product.id -%}
            <div class="cart-upsell-item" data-product-id="{{ product.id }}">
              <div class="cart-upsell-image">
                {%- if product.featured_image != blank -%}
                  {{ product.featured_image | image_url: width: 80 | image_tag: loading: 'lazy', class: 'cart-upsell-img' }}
                {%- endif -%}
              </div>
              <div class="cart-upsell-info">
                <h4 class="cart-upsell-product-title">{{ product.title | truncate: 40 }}</h4>
                <div class="cart-upsell-price">
                  {%- if product.compare_at_price > product.price -%}
                    <span class="cart-upsell-compare-price">{{ product.compare_at_price | money }}</span>
                  {%- endif -%}
                  <span class="cart-upsell-current-price">{{ product.price | money }}</span>
                </div>
                {%- if product.tags contains 'bestseller' -%}
                  <span class="cart-upsell-badge">Bestseller</span>
                {%- elsif product.tags contains 'new' -%}
                  <span class="cart-upsell-badge cart-upsell-badge--new">Nouveau</span>
                {%- endif -%}
              </div>
              <button 
                type="button" 
                class="cart-upsell-add-btn"
                data-variant-id="{{ product.selected_or_first_available_variant.id }}"
                data-product-title="{{ product.title }}"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                Ajouter
              </button>
            </div>
          {%- endunless -%}
        {%- endfor -%}
      {%- endif -%}
      
      {%- comment -%} Fallback: Recommandations bas√©es sur les produits du panier {%- endcomment -%}
      {%- if settings.upsell_collection == blank -%}
        {%- for item in cart.items limit: 1 -%}
          {%- if item.product.collections.first != blank -%}
            {%- assign related_collection = item.product.collections.first -%}
            {%- for product in related_collection.products limit: max_upsells -%}
              {%- unless cart_product_ids contains product.id -%}
                <div class="cart-upsell-item" data-product-id="{{ product.id }}">
                  <div class="cart-upsell-image">
                    {%- if product.featured_image != blank -%}
                      {{ product.featured_image | image_url: width: 80 | image_tag: loading: 'lazy', class: 'cart-upsell-img' }}
                    {%- endif -%}
                  </div>
                  <div class="cart-upsell-info">
                    <h4 class="cart-upsell-product-title">{{ product.title | truncate: 40 }}</h4>
                    <div class="cart-upsell-price">
                      {%- if product.compare_at_price > product.price -%}
                        <span class="cart-upsell-compare-price">{{ product.compare_at_price | money }}</span>
                      {%- endif -%}
                      <span class="cart-upsell-current-price">{{ product.price | money }}</span>
                    </div>
                  </div>
                  <button 
                    type="button" 
                    class="cart-upsell-add-btn"
                    data-variant-id="{{ product.selected_or_first_available_variant.id }}"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    Ajouter
                  </button>
                </div>
              {%- endunless -%}
            {%- endfor -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}
    </div>
    
    {%- comment -%} Message de livraison gratuite {%- endcomment -%}
    {%- assign free_shipping_threshold = settings.free_shipping_threshold | default: 5000 -%}
    {%- assign amount_to_free_shipping = free_shipping_threshold | minus: cart.total_price -%}
    
    {%- if amount_to_free_shipping > 0 -%}
      <div class="cart-upsell-shipping">
        <div class="cart-upsell-shipping-bar">
          <div class="cart-upsell-shipping-progress" style="width: {{ cart.total_price | times: 100 | divided_by: free_shipping_threshold | at_most: 100 }}%;"></div>
        </div>
        <p class="cart-upsell-shipping-text">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
          Plus que <strong>{{ amount_to_free_shipping | money }}</strong> pour la livraison gratuite !
        </p>
      </div>
    {%- else -%}
      <div class="cart-upsell-shipping cart-upsell-shipping--success">
        <p class="cart-upsell-shipping-text">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
          üéâ F√©licitations ! Vous b√©n√©ficiez de la livraison gratuite !
        </p>
      </div>
    {%- endif -%}
  </div>
{%- endif -%}

<style>
  .cart-upsell-automation {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
  }
  
  .cart-upsell-header {
    text-align: center;
    margin-bottom: 20px;
  }
  
  .cart-upsell-title {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-size: 16px;
    font-weight: 700;
    margin: 0 0 5px;
    color: #1a1a1a;
  }
  
  .cart-upsell-title svg {
    color: #ef4444;
  }
  
  .cart-upsell-subtitle {
    font-size: 13px;
    color: #6c757d;
    margin: 0;
  }
  
  .cart-upsell-products {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  
  .cart-upsell-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: #ffffff;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    transition: box-shadow 0.2s ease;
  }
  
  .cart-upsell-item:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }
  
  .cart-upsell-image {
    flex-shrink: 0;
    width: 60px;
    height: 60px;
    border-radius: 6px;
    overflow: hidden;
    background: #f8f9fa;
  }
  
  .cart-upsell-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .cart-upsell-info {
    flex-grow: 1;
    min-width: 0;
  }
  
  .cart-upsell-product-title {
    font-size: 13px;
    font-weight: 600;
    margin: 0 0 4px;
    color: #1a1a1a;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .cart-upsell-price {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .cart-upsell-compare-price {
    font-size: 11px;
    color: #adb5bd;
    text-decoration: line-through;
  }
  
  .cart-upsell-current-price {
    font-size: 13px;
    font-weight: 700;
    color: #1a1a1a;
  }
  
  .cart-upsell-badge {
    display: inline-block;
    margin-top: 4px;
    padding: 2px 6px;
    font-size: 9px;
    font-weight: 600;
    text-transform: uppercase;
    background: #fef3c7;
    color: #b45309;
    border-radius: 3px;
  }
  
  .cart-upsell-badge--new {
    background: #dcfce7;
    color: #166534;
  }
  
  .cart-upsell-add-btn {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 8px 12px;
    font-size: 12px;
    font-weight: 600;
    color: #ffffff;
    background: linear-gradient(135deg, #1a1a1a 0%, #333333 100%);
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  
  .cart-upsell-add-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }
  
  .cart-upsell-add-btn:active {
    transform: translateY(0);
  }
  
  .cart-upsell-shipping {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #e9ecef;
  }
  
  .cart-upsell-shipping-bar {
    height: 6px;
    background: #e9ecef;
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 8px;
  }
  
  .cart-upsell-shipping-progress {
    height: 100%;
    background: linear-gradient(90deg, #fbbf24 0%, #22c55e 100%);
    border-radius: 3px;
    transition: width 0.3s ease;
  }
  
  .cart-upsell-shipping-text {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    font-size: 13px;
    color: #6c757d;
    margin: 0;
  }
  
  .cart-upsell-shipping--success .cart-upsell-shipping-text {
    color: #166534;
  }
  
  .cart-upsell-shipping--success .cart-upsell-shipping-text svg {
    color: #22c55e;
  }
</style>

<script>
  // Script pour ajouter les produits au panier
  document.addEventListener('DOMContentLoaded', function() {
    const upsellButtons = document.querySelectorAll('.cart-upsell-add-btn');
    
    upsellButtons.forEach(function(button) {
      button.addEventListener('click', function() {
        const variantId = this.dataset.variantId;
        const originalText = this.innerHTML;
        
        // Feedback visuel
        this.innerHTML = '<span class="loading-spinner"></span>';
        this.disabled = true;
        
        // Ajouter au panier via l'API Shopify
        fetch('/cart/add.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            id: variantId,
            quantity: 1
          })
        })
        .then(response => response.json())
        .then(data => {
          this.innerHTML = '‚úì Ajout√©';
          this.style.background = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
          
          // Recharger le panier apr√®s 1 seconde
          setTimeout(function() {
            window.location.reload();
          }, 1000);
        })
        .catch(error => {
          this.innerHTML = originalText;
          this.disabled = false;
          console.error('Erreur:', error);
        });
      });
    });
  });
</script>
