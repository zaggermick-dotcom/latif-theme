{%- comment -%}
  MEDIAS.LIQUID - LATIF SKIN v9.0 FINAL
  ✅ SUPPRIME COMPLÈTEMENT LES ANCIENNES MINIATURES
  ✅ UNE SEULE RANGÉE SOUS L'IMAGE
{%- endcomment -%}

{%- liquid
  if superGlue
    assign swiperSpacing = 0
    assign swiperSpacingDesktop = 0
  else
    assign swiperSpacing = 6
    assign swiperSpacingDesktop = 12
  endif
  
  assign ratio = 1
  if product.featured_media and media_aspect_ratio == 'portrait'
    assign ratio = 0.8
  endif
  
  assign variant_media_ids = ''
  if exclude_variant_images
    for variant in product.variants
      if variant.featured_media
        assign variant_media_ids = variant_media_ids | append: variant.featured_media.id | append: ','
      endif
    endfor
  endif
  
  assign non_variant_media_count = 0
  for media in product.media
    assign is_variant_image = false
    if exclude_variant_images and variant_media_ids contains media.id
      assign is_variant_image = true
    endif
    unless is_variant_image
      assign non_variant_media_count = non_variant_media_count | plus: 1
    endunless
  endfor
  
  assign is_mobile_call = false
  if swiperThumbsEl contains 'Mobile'
    assign is_mobile_call = true
  endif
-%}

<div class="product__media--inner latif-media-wrapper">
  {%- if product != blank -%}
    
    {%- comment -%} IMAGE PRINCIPALE UNIQUEMENT {%- endcomment -%}
    <div class="product__main-medias{% if section.settings.media_layout_desktop == 'grid' %} product__main-medias--grid{% endif %}">
      
      {%- if section.settings.media_layout_desktop == 'grid' -%}
        <div class="product__grid-wrapper hide-on-mobile{% if non_variant_media_count == 1 %} product__grid-wrapper--single{% endif %}">
          {%- for media in product.media -%}
            {%- liquid
              assign is_variant_image = false
              if exclude_variant_images and variant_media_ids contains media.id
                assign is_variant_image = true
              endif
            -%}
            {%- unless is_variant_image -%}
            <div class="product__grid-item" data-popup-trigger="media_{{ section.id }}_{{ media.id }}">
              {%- if media_aspect_ratio == 'adapt' -%}
                {%- assign ratio = media.preview_image.aspect_ratio -%}
              {%- endif -%}
              {%- render 'media', media: media, ratio: ratio, enable_zoom: enable_zoom -%}
              <div class="product__grid-item-zoom">
                {%- render 'icon-zoom' -%}
              </div>
            </div>
            {%- endunless -%}
          {%- endfor -%}
        </div>
      {%- endif -%}
      
      {%- comment -%} SWIPER IMAGE PRINCIPALE {%- endcomment -%}
      <div
        id="{{ swiperMediaEl }}{{ unique }}"
        class="swiper{% if thumbnails != true %} swiper_no_pagination{% endif %} product__swiper product__medias-wrapper{% if section.settings.media_layout_desktop == 'grid' %} show-on-mobile{% endif %}"
        {% render 'swiper-data-editor', numberOfSlides: non_variant_media_count -%}
        data-swiper-id="{{ swiperMediaEl }}{{ unique }}"
      >
        <div class="swiper-wrapper product__grid">
          {%- for media in product.media -%}
            {%- liquid
              assign is_variant_image = false
              if variant_media_ids contains media.id
                assign is_variant_image = true
              endif
            -%}
            {%- unless is_variant_image -%}
            <div class="swiper-slide product__slide">
              {%- if media_aspect_ratio == 'adapt' -%}
                {%- assign ratio = media.preview_image.aspect_ratio -%}
              {%- endif -%}
              {%- render 'media', media: media, ratio: ratio, enable_zoom: enable_zoom -%}
            </div>
            {%- endunless -%}
          {%- endfor -%}
        </div>
      </div>
      
      {%- liquid
        if non_variant_media_count > 1
          render 'swiper-elements', unique: unique, pagination: pagination, navigation: navigation
        endif
      -%}
      
    </div>

    {%- comment -%} ═══════════════════════════════════════════════════════════
      MINIATURES SOUS L'IMAGE - UNE SEULE RANGÉE
      Affichées uniquement pour l'appel principal (pas mobile)
    ═══════════════════════════════════════════════════════════════ {%- endcomment -%}
    
    {%- if non_variant_media_count > 1 and is_mobile_call == false -%}
      <div class="latif-thumbs-final" id="latifThumbsFinal-{{ unique }}">
        <div class="latif-thumbs-final__track">
          {%- assign thumb_idx = 0 -%}
          {%- for media in product.media -%}
            {%- liquid
              assign is_variant_image = false
              if exclude_variant_images and variant_media_ids contains media.id
                assign is_variant_image = true
              endif
            -%}
            {%- unless is_variant_image -%}
              <button 
                type="button"
                class="latif-thumb-btn{% if thumb_idx == 0 %} active{% endif %}"
                data-index="{{ thumb_idx }}"
                aria-label="Image {{ thumb_idx | plus: 1 }}"
              >
                <img 
                  src="{{ media.preview_image | image_url: width: 150 }}" 
                  alt="{{ media.alt | escape | default: product.title }}"
                  width="64"
                  height="64"
                  loading="lazy"
                >
              </button>
              {%- assign thumb_idx = thumb_idx | plus: 1 -%}
            {%- endunless -%}
          {%- endfor -%}
        </div>
      </div>
    {%- endif -%}

    {%- comment -%} SWIPER CONFIG - SANS THUMBS NATIFS {%- endcomment -%}
    {%- liquid
      if non_variant_media_count > 1
        if enable_zoom
          assign zoom = 'zoom: true,'
        endif
        assign swiperEl = "'#" | append: swiperMediaEl | append: unique | append: "'"
        if preShotSwiper and non_variant_media_count > 1
          assign slidesPerView = 1.2
        else
          assign slidesPerView = 1
        endif
        assign swiperOptions = "loop:false,mousewheel:{forceToAxis:true},spaceBetween:" | append: swiperSpacing | append: ",slidesPerView:" | append: slidesPerView | append: ",autoHeight:true," | append: zoom | append: "breakpoints:{750:{spaceBetween:" | append: swiperSpacingDesktop | append: "}},"
        render 'swiper-theme-editor', sectionId: unique, swiperVariant: swiperMediaEl, swiperEl: swiperEl, swiperOptions: swiperOptions, numberOfBlocks: non_variant_media_count, navigation: 'already', pagination: 'already'
      endif
    -%}

  {%- else -%}
    <div class="global-media-settings placeholder">
      {{ 'product-1' | placeholder_svg_tag }}
    </div>
  {%- endif -%}
</div>

{%- if section.settings.media_layout_desktop == 'grid' -%}
  <media-popup>
    {%- render 'block-media-popups', exclude_variant_images: exclude_variant_images -%}
  </media-popup>
  {%- render 'script' with 'media-popup', defer: true -%}
{%- endif -%}

{%- comment -%} ═══════════════════════════════════════════════════════════
  CSS - FORCER LA SUPPRESSION DES ANCIENNES MINIATURES
═══════════════════════════════════════════════════════════════ {%- endcomment -%}

<style>
/* SUPPRIMER TOUTES LES ANCIENNES MINIATURES DU THÈME */
.latif-media-wrapper .product__thumbs-wrapper,
.latif-media-wrapper [id^="productThumbs"],
.latif-media-wrapper [id^="productThumbsMobile"],
.product__medias > .product__thumbs-wrapper,
.product__media--inner > .product__thumbs-wrapper,
.product__thumbs-wrapper:not(.latif-thumbs-final),
[class*="thumbs-wrapper"]:not(.latif-thumbs-final),
.product__thumbs-only_desktop,
.product__thumbs-desktop-only {
  display: none !important;
  visibility: hidden !important;
  height: 0 !important;
  max-height: 0 !important;
  overflow: hidden !important;
  opacity: 0 !important;
  pointer-events: none !important;
  position: absolute !important;
  left: -99999px !important;
}

/* NOTRE NOUVELLE RANGÉE DE MINIATURES */
.latif-thumbs-final {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
  position: relative !important;
  left: auto !important;
  height: auto !important;
  max-height: none !important;
  overflow: visible !important;
  pointer-events: auto !important;
  margin-top: 12px;
  padding: 0 6px;
  width: 100%;
}

.latif-thumbs-final__track {
  display: flex;
  gap: 8px;
  overflow-x: auto;
  scroll-snap-type: x mandatory;
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
  padding: 6px 2px;
}

.latif-thumbs-final__track::-webkit-scrollbar {
  display: none;
}

.latif-thumb-btn {
  flex-shrink: 0;
  width: 64px;
  height: 64px;
  padding: 0;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  background: #fff;
  cursor: pointer;
  overflow: hidden;
  scroll-snap-align: start;
  transition: all 0.2s ease;
}

.latif-thumb-btn:hover {
  border-color: #999;
}

.latif-thumb-btn.active {
  border-color: #8B5A8B;
  box-shadow: 0 0 0 3px rgba(139, 90, 139, 0.25);
}

.latif-thumb-btn img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 6px;
  pointer-events: none;
}

/* MOBILE */
@media (max-width: 749px) {
  .latif-thumbs-final {
    margin-top: 10px;
  }
  
  .latif-thumb-btn {
    width: 56px;
    height: 56px;
  }
  
  .latif-thumbs-final__track {
    gap: 6px;
  }
}

/* DESKTOP - CENTRER */
@media (min-width: 750px) {
  .latif-thumbs-final__track {
    justify-content: center;
  }
  
  .latif-thumb-btn {
    width: 70px;
    height: 70px;
  }
}
</style>

{%- comment -%} JAVASCRIPT - SYNCHRONISATION {%- endcomment -%}

<script>
(function() {
  document.addEventListener('DOMContentLoaded', function() {
    var container = document.getElementById('latifThumbsFinal-{{ unique }}');
    if (!container) return;
    
    var thumbs = container.querySelectorAll('.latif-thumb-btn');
    var swiperId = '{{ swiperMediaEl }}{{ unique }}';
    var swiperEl = document.getElementById(swiperId);
    
    if (!thumbs.length || !swiperEl) return;
    
    function setActive(index) {
      thumbs.forEach(function(t, i) {
        t.classList.toggle('active', i === index);
      });
      if (thumbs[index]) {
        thumbs[index].scrollIntoView({ 
          behavior: 'smooth', 
          inline: 'center', 
          block: 'nearest' 
        });
      }
    }
    
    thumbs.forEach(function(thumb) {
      thumb.addEventListener('click', function() {
        var idx = parseInt(this.dataset.index);
        if (swiperEl.swiper) {
          swiperEl.swiper.slideTo(idx);
        }
        setActive(idx);
      });
    });
    
    var checkInterval = setInterval(function() {
      if (swiperEl.swiper) {
        clearInterval(checkInterval);
        swiperEl.swiper.on('slideChange', function() {
          setActive(this.activeIndex);
        });
      }
    }, 100);
    
    setTimeout(function() { 
      clearInterval(checkInterval); 
    }, 5000);
  });
})();
</script>